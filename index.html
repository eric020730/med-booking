<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å½±éƒ¨æ’èª²åŠ©ç†</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-main { @apply w-full py-5 rounded-[2rem] font-black transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm text-lg; }
        .btn-primary { @apply btn-main bg-blue-600 text-white shadow-blue-100; }
        .btn-secondary { @apply btn-main bg-slate-100 text-slate-600; }
        
        /* æ—¥æ›†å–®å…ƒæ ¼åŸºç¤æ¨£å¼ */
        .day-cell { @apply min-h-[130px] border border-slate-50 rounded-[2.5rem] p-3 flex flex-col items-center relative transition-all bg-white cursor-pointer shadow-sm; }
        
        /* ç•¶å¤©æ—¥æœŸçš„ç°¡ç´„æ¨™ç¤ºï¼šæ•¸å­—èƒŒæ™¯è—åœ“ */
        .today-marker { @apply bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center; }
        
        /* éå»æ—¥æœŸçš„æ·¡åŒ–æ¨£å¼ */
        .past-date { @apply opacity-30 grayscale-[0.2]; }
        
        .week-highlight { @apply ring-4 ring-blue-500/50 bg-blue-50 z-10 scale-105; }
        
        /* èª²ç¨‹æ¨™ç±¤æ¨£å¼ */
        .my-event-bg { background-color: #f3e8ff !important; color: #7e22ce !important; }
        .my-event-border { border-color: #e9d5ff !important; background-color: #faf5ff !important; }
        .my-event-text { color: #7e22ce !important; font-weight: 900 !important; }
        .my-event-btn { background-color: #9333ea !important; color: white !important; }

        /* é€±æ¬¡æ¨™ç±¤æ¨£å¼ */
        .week-label { @apply flex items-center justify-center text-slate-400 font-bold text-[10px] h-full; }
        .week-label-text { @apply transform -rotate-0 text-center leading-tight; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 antialiased">
    <div id="app" class="max-w-md mx-auto p-4 pb-40">
        <!-- è¼‰å…¥å‹•ç•« -->
        <div id="loading" class="fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-blue-600 mb-6"></div>
            <p class="text-slate-600 font-black text-lg">åŒæ­¥æ—¥æ›†ä¸­...</p>
        </div>

        <div id="page-content" class="hidden">
            <!-- ç¶å®šä»‹é¢ -->
            <div id="view-binding" class="hidden space-y-8 pt-10 px-2">
                <div class="text-center mb-10">
                    <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-4 text-3xl">ğŸ‘¤</div>
                    <h2 class="text-3xl font-black">èº«åˆ†è¾¨è­˜</h2>
                    <p class="text-slate-400 mt-2">è«‹é¸æ“‡æ‚¨çš„å§“åä»¥ç¶å®šç³»çµ±</p>
                </div>
                <div id="binding-list" class="grid grid-cols-1 gap-4 overflow-y-auto max-h-[65vh] pb-20"></div>
            </div>

            <!-- ä¸»åŠŸèƒ½ä»‹é¢ -->
            <div id="view-main" class="hidden">
                <header class="text-center mb-8 pt-4">
                    <h1 id="page-title" class="text-2xl font-black text-slate-900">é†«å½±éƒ¨æ•™å­¸ç³»çµ±</h1>
                    <p id="user-info" class="text-blue-600 text-sm font-black mt-2 bg-blue-50 inline-block px-5 py-1.5 rounded-full"></p>
                </header>

                <!-- ç®¡ç†å“¡é¢æ¿ -->
                <div id="admin-panel" class="fixed bottom-0 left-0 right-0 bg-white p-8 rounded-t-[3rem] shadow-[0_-20px_60px_rgba(0,0,0,0.1)] z-40 hidden border-t border-slate-100">
                    <div class="max-w-md mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="selected-week-range" class="font-black text-slate-800 text-xl">è«‹é¸å–æ—¥æœŸ</h3>
                            <button onclick="clearSelection()" class="text-xs bg-slate-100 px-4 py-1.5 rounded-full text-slate-500 font-bold">é‡é¸</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button onclick="adminBatchAction('single', 1)" class="btn-secondary text-sm">Week 1 æ¨¡æ¿</button>
                            <button onclick="adminBatchAction('single', 2)" class="btn-secondary text-sm">Week 2 æ¨¡æ¿</button>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="adminBatchAction('four_weeks')" class="flex-1 bg-emerald-600 text-white py-5 rounded-[1.5rem] font-black text-sm">æ–°å¢å››é€±</button>
                            <button onclick="adminBatchAction('delete')" class="flex-1 bg-red-50 text-red-600 py-5 rounded-[1.5rem] font-black text-sm">åˆªé™¤æ­¤é€±</button>
                        </div>
                    </div>
                </div>

                <div id="calendar-container" class="bg-white rounded-[3rem] p-4 shadow-xl mb-6 border border-slate-100">
                    <div class="text-xs font-black text-slate-400 uppercase mb-6 flex justify-between items-center px-2">
                        <span id="instruction-text">è¼‰å…¥ä¸­...</span>
                        <span id="mode-badge" class="bg-blue-600 px-4 py-1.5 rounded-full text-white font-black"></span>
                    </div>
                    
                    <div id="course-selector" class="mb-8 hidden px-2">
                        <div id="course-list" class="grid grid-cols-1 gap-3"></div>
                    </div>

                    <!-- æœˆæ›†ä¸»é«”ï¼šèª¿æ•´ç‚º 6 æ¬„ (é€±æ¬¡å¯¬åº¦å›ºå®š 40pxï¼Œå…¶é¤˜ 5 æ¬„å¹³åˆ†) -->
                    <div id="calendar" class="grid grid-cols-[40px_repeat(5,1fr)] gap-2 text-center"></div>
                    
                    <!-- æ™‚æ®µè©³æƒ… -->
                    <div id="day-detail" class="mt-12 pt-10 border-t-2 border-slate-50 hidden">
                        <h3 id="selected-date-text" class="text-2xl font-black text-slate-800 mb-8 px-2"></h3>
                        <div id="time-slots" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸå½ˆçª— -->
    <div id="modal-success" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-6 z-[70] backdrop-blur-md">
        <div class="bg-white rounded-[3rem] p-12 w-full max-w-sm text-center shadow-2xl scale-105">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 text-3xl">âœ“</div>
            <h3 class="text-2xl font-black mb-4">æ“ä½œæˆåŠŸ</h3>
            <p id="success-msg" class="text-slate-500 mb-10 text-base"></p>
            <button onclick="closeSuccessModal()" class="w-full py-5 rounded-[2rem] font-black bg-slate-900 text-white">é—œé–‰</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbypD06URR3lpVo-5jwOX7rP8WM-WRGJGZY54t3uTnBE8DS2SD-BEiqyYAFMpYHmDt3APA/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        
        let state = { userId: null, name: '', rawName: '', action: 'view', allEvents: [], course: null, selectedMonday: null, userCourses: [], selectedDate: null };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.userId = profile.userId;
                state.action = new URLSearchParams(window.location.search).get('action') || 'view';

                await refreshData();
                if (!state.name || state.name === 'è¨ªå®¢' || state.name === "") { await showBindingView(); }
                else { showMainView(); }
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            const [userRes, eventRes] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                fetch(`${GAS_URL}?action=getAllEvents`)
            ]);
            const userData = await userRes.json();
            state.allEvents = await eventRes.json(); 
            state.rawName = (userData.name || 'è¨ªå®¢').trim();
            state.name = state.rawName.replace(/\s+/g, '').replace(/é†«å¸«/g, '');
            state.userCourses = (userData.courses || []).map(c => c ? c.trim() : "").filter(c => c !== "");
        }

        function showMainView() {
            document.getElementById('user-info').textContent = `${state.rawName} é†«å¸«`;
            setupModeUI();
            renderCalendar();
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            
            // è¡¨é ­ï¼šç¬¬ä¸€æ¬„ç‚ºç©ºï¼Œå¾ŒçºŒç‚ºé€±ä¸€è‡³é€±äº”
            container.innerHTML += `<div></div>`;
            ['ä¸€','äºŒ','ä¸‰','å››','äº”'].forEach(w => {
                container.innerHTML += `<div class="text-slate-400 py-4 font-black text-lg">${w}</div>`;
            });

            const now = new Date();
            const todayStr = formatDate(now);
            const startMonday = new Date(now);
            startMonday.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
            startMonday.setHours(0,0,0,0);

            for (let week = 0; week < 6; week++) {
                // å…ˆè¨ˆç®—é€™ä¸€é€±æœ‰æ²’æœ‰æ’èª²
                let hasEventsInWeek = false;
                const weekDates = [];
                for(let day = 0; day < 5; day++) {
                    const tempDate = new Date(startMonday);
                    tempDate.setDate(startMonday.getDate() + (week * 7) + day);
                    const ds = formatDate(tempDate);
                    weekDates.push(ds);
                    if (state.allEvents.some(e => e.dateOnly === ds)) {
                        hasEventsInWeek = true;
                    }
                }

                // æ¯ä¸€é€±çš„ç¬¬ä¸€æ¬„ï¼šé¡¯ç¤ºé€±æ¬¡æ¨™ç±¤ï¼ˆè‹¥è©²é€±ç„¡èª²å‰‡ä¸é¡¯ç¤ºï¼‰
                const weekLabelDiv = document.createElement('div');
                weekLabelDiv.className = "week-label";
                if (hasEventsInWeek) {
                    weekLabelDiv.innerHTML = `<div class="week-label-text">W${week + 1}<br>èª²ç¨‹</div>`;
                }
                container.appendChild(weekLabelDiv);
                
                // æ¸²æŸ“é€±ä¸€è‡³é€±äº”çš„å…§å®¹
                for (let day = 0; day < 5; day++) {
                    const d = new Date(startMonday);
                    d.setDate(startMonday.getDate() + (week * 7) + day);
                    const dateStr = formatDate(d);
                    const isToday = (dateStr === todayStr);
                    const isPast = (d < new Date().setHours(0,0,0,0)); 
                    
                    const events = state.allEvents.filter(e => e.dateOnly === dateStr);
                    
                    const el = document.createElement('div');
                    el.dataset.date = dateStr;
                    el.className = `day-cell ${isPast ? 'past-date' : ''}`;
                    
                    // æ—¥æœŸæ•¸å­—å‘ˆç¾
                    const dateDisplayClass = isToday ? 'today-marker' : 'text-slate-800';
                    el.innerHTML = `<div class="text-2xl mb-4 font-black ${dateDisplayClass}">${d.getDate()}</div>`;
                    
                    events.forEach(e => {
                        const info = parseEventTitle(e.title);
                        const hour = e.start.split('T')[1].substring(0,2);
                        // éå»æ—¥æœŸçš„èª²ç¨‹é¡¯ç¤ºè¼ƒæ·¡ç”±çˆ¶å®¹å™¨çš„ past-date è™•ç†
                        el.innerHTML += `<div class="text-[9px] leading-tight rounded-lg px-2 py-1 mb-1 w-full truncate text-left font-bold ${info.isMine ? 'my-event-bg' : 'bg-blue-100 text-blue-700'}">${hour}h ${info.display}</div>`;
                    });

                    el.onclick = () => handleDateClick(d, el, events);
                    container.appendChild(el);
                }
            }
        }

        function setupModeUI() {
            const badge = document.getElementById('mode-badge');
            const inst = document.getElementById('instruction-text');
            const title = document.getElementById('page-title');
            if (state.action === 'admin') { title.textContent = "æ’èª²å¾Œå°"; badge.textContent = "ç®¡ç†å“¡"; inst.textContent = "é»æ“Šä»»ä¸€å¤©é¸å–é€±æ¬¡"; }
            else if (state.action === 'book') { title.textContent = "é ç´„èª²ç¨‹"; badge.textContent = "é ç´„æ¨¡å¼"; document.getElementById('course-selector').classList.remove('hidden'); renderCourseButtons(); inst.textContent = "é¸å–ä¸»é¡Œå¾Œé»æ—¥æœŸ"; }
            else if (state.action === 'modify') { title.textContent = "æ›´å‹•å–æ¶ˆ"; badge.textContent = "ä¿®æ”¹æ¨¡å¼"; inst.textContent = "é»æ“Šç´«è‰²æ™‚æ®µå–æ¶ˆ"; }
            else { title.textContent = "å…¨é™¢èª²è¡¨"; badge.textContent = "æŸ¥è©¢æ¨¡å¼"; inst.textContent = "é»æ“Šæ—¥æœŸæŸ¥çœ‹è©³æƒ…"; }
        }

        function formatDate(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function parseEventTitle(title) {
            const match = title.match(/(.*)\((.*)\)/);
            if (match) {
                let p1 = match[1].trim(); let p2 = match[2].trim();
                const cp1 = p1.replace(/\s+/g, '').replace(/é†«å¸«/g, '');
                const cp2 = p2.replace(/\s+/g, '').replace(/é†«å¸«/g, '');
                const isMine = (cp1 === state.name || cp2 === state.name);
                return { display: `${p1.includes('é†«å¸«') ? p1 : p2}(${p1.includes('é†«å¸«') ? p2 : p1})`, isMine: isMine };
            }
            return { display: title.trim(), isMine: false };
        }

        function handleDateClick(date, el, events) {
            if (state.action === 'admin') selectWeek(date);
            else { state.selectedDate = date; showDayDetail(date, el, events); }
        }

        function selectWeek(date) {
            const monday = new Date(date); monday.setDate(date.getDate() - (date.getDay() === 0 ? 6 : date.getDay() - 1));
            state.selectedMonday = monday;
            const friday = new Date(monday); friday.setDate(monday.getDate() + 4);
            document.querySelectorAll('.day-cell').forEach(cell => {
                const d = new Date(cell.dataset.date);
                if (d >= monday && d <= friday) cell.classList.add('week-highlight');
                else cell.classList.remove('week-highlight');
            });
            document.getElementById('selected-week-range').textContent = `${monday.getMonth()+1}/${monday.getDate()} - ${friday.getMonth()+1}/${friday.getDate()}`;
            document.getElementById('admin-panel').classList.remove('hidden');
        }

        function showDayDetail(date, el, events) {
            document.querySelectorAll('.day-cell').forEach(d => d.classList.remove('ring-8', 'ring-blue-500/10', 'z-10', 'scale-105'));
            el.classList.add('ring-8', 'ring-blue-500/10', 'z-10', 'scale-105');
            const dateStr = formatDate(date);
            document.getElementById('day-detail').classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = dateStr + " è©³æƒ…";
            const tc = document.getElementById('time-slots');
            tc.innerHTML = '';
            [9, 10, 11, 13, 14, 15, 16].forEach(h => {
                const booked = events.find(e => parseInt(e.start.split('T')[1].substring(0,2)) === h);
                const info = booked ? parseEventTitle(booked.title) : null;
                const row = document.createElement('div');
                row.className = `w-full p-6 rounded-[2rem] border-2 flex justify-between items-center font-black ${booked ? (info.isMine ? 'my-event-border' : 'bg-blue-50/20 border-blue-100') : 'bg-white border-slate-100'}`;
                
                let actionBtn = `<span class="text-slate-400 text-sm">ç©ºé–’æ™‚æ®µ</span>`;
                if (state.action === 'book') {
                    actionBtn = booked ? `<span class="text-slate-300 text-xs">å·²è¢«é ç´„</span>` : `<button onclick="doBooking('${dateStr}T${String(h).padStart(2,'0')}:00:00')" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-xs">é»æ“Šé ç´„</button>`;
                } else if (state.action === 'modify' && booked && info.isMine) {
                    actionBtn = `<button onclick="doCancel('${booked.id}')" class="my-event-btn px-6 py-2 rounded-xl text-xs">å–æ¶ˆé ç´„</button>`;
                }
                
                row.innerHTML = `<span>${h}:00 ${booked ? info.display : ''}</span> ${actionBtn}`;
                tc.appendChild(row);
            });
            document.getElementById('day-detail').scrollIntoView({ behavior: 'smooth' });
        }

        async function doBooking(time) { if(!state.course) return alert('è«‹å…ˆé¸å–æˆèª²ä¸»é¡Œ'); if(confirm('ç¢ºå®šé ç´„æ­¤æ™‚æ®µå—ï¼Ÿ')){ startLoad(); const res = await (await fetch(`${GAS_URL}?action=submitBooking&name=${state.rawName}&course=${state.course}&startTime=${time}&userId=${state.userId}`)).json(); if(res.status==='success') showSuccess('é ç´„æˆåŠŸï¼Œè¨Šæ¯å·²æ¨é€ã€‚'); } }
        async function doCancel(id) { if(confirm('ç¢ºå®šå–æ¶ˆæ­¤èª²ç¨‹å—ï¼Ÿ')){ startLoad(); const res = await (await fetch(`${GAS_URL}?action=cancelBooking&eventId=${id}&userId=${state.userId}`)).json(); if(res.status==='success') showSuccess('å·²æˆåŠŸå–æ¶ˆé ç´„ã€‚'); } }
        function startLoad() { document.getElementById('loading').classList.remove('hidden'); }
        function showSuccess(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('success-msg').textContent = msg; document.getElementById('modal-success').classList.replace('hidden', 'flex'); }
        async function closeSuccessModal() { location.reload(); }
        window.onload = init;
    </script>
</body>
</html>
