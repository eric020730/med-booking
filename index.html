<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å½±éƒ¨æ’èª²åŠ©ç†</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-main { @apply w-full py-5 rounded-3xl font-black transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm; }
        .btn-primary { @apply btn-main bg-blue-600 text-white shadow-blue-200; }
        .btn-secondary { @apply btn-main bg-slate-100 text-slate-600; }
        
        /* æœˆæ›†æ ¼å­ï¼šæ¥µè‡´æ”¾å¤§èˆ‡ç²¾ç·»åœ“è§’ */
        .day-cell { @apply min-h-[140px] border border-slate-100 rounded-[2rem] p-3 flex flex-col items-center relative transition-all bg-white cursor-pointer hover:bg-slate-50 hover:shadow-md; }
        .is-today { @apply border-blue-500 border-[3px] bg-blue-50/50 shadow-inner; }
        
        /* èª²ç¨‹æ¨™ç±¤ï¼šå­—é«”æ”¾å¤§èˆ‡ç‰ˆé¢ç¾åŒ– */
        .event-label { @apply text-[11px] leading-snug rounded-xl px-3 py-1.5 mb-1.5 w-full truncate text-left font-bold shadow-sm; }
        
        /* ç´«è‰²é«˜äº®æ¨£å¼ (ä½¿ç”¨è€…æœ¬äººçš„èª²ç¨‹) */
        .my-event-bg { background-color: #f3e8ff !important; color: #7e22ce !important; border: 1px solid #e9d5ff; }
        .my-event-border { border-color: #e9d5ff !important; background-color: #faf5ff !important; }
        .my-event-text { color: #7e22ce !important; font-weight: 900 !important; }
        .my-event-btn { background-color: #9333ea !important; color: white !important; box-shadow: 0 10px 20px -5px rgba(147, 51, 234, 0.3) !important; }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 antialiased">
    <div id="app" class="max-w-2xl mx-auto p-4 pb-40">
        <!-- è®€å–é®ç½© -->
        <div id="loading" class="fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-blue-600 border-r-4 border-r-transparent mb-6"></div>
            <p class="text-slate-600 font-black text-lg text-center tracking-wider">é†«å½±éƒ¨ç³»çµ±åŒæ­¥ä¸­...<br><span class="text-xs font-bold text-slate-400 mt-2 block">æ­£åœ¨å„ªåŒ–äº”æ—¥æ”¾å¤§ç‰ˆä»‹é¢</span></p>
        </div>

        <div id="page-content" class="hidden">
            <!-- ç¶å®šä»‹é¢ -->
            <div id="view-binding" class="hidden space-y-8 pt-10">
                <div class="text-center px-6 mb-10">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 text-4xl shadow-xl shadow-blue-100">ğŸ‘¤</div>
                    <h2 class="text-3xl font-black text-slate-800 tracking-tight">èº«åˆ†è¾¨è­˜</h2>
                    <p class="text-slate-400 text-sm mt-3 leading-relaxed">è«‹åœ¨ä¸‹æ–¹åå–®ä¸­é¸å–æ‚¨çš„å§“å<br>ä»¥å®Œæˆè¡Œå‹•æ’èª²ç³»çµ±ç¶å®š</p>
                </div>
                <div id="binding-list" class="grid grid-cols-1 gap-4 px-2 overflow-y-auto max-h-[60vh] pb-20"></div>
            </div>

            <!-- ä¸»åŠŸèƒ½ä»‹é¢ -->
            <div id="view-main" class="hidden">
                <header class="text-center mb-8 pt-4">
                    <h1 id="page-title" class="text-3xl font-black tracking-tighter text-slate-900">é†«å½±éƒ¨æ•™å­¸ç³»çµ±</h1>
                    <p id="user-info" class="text-blue-600 text-sm font-black mt-2 bg-blue-50 inline-block px-4 py-1 rounded-full"></p>
                </header>

                <div id="calendar-container" class="bg-white rounded-[3rem] p-6 shadow-xl shadow-slate-200/50 mb-6 border border-slate-100">
                    <!-- ç‹€æ…‹èˆ‡èªªæ˜ -->
                    <div id="calendar-instruction" class="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 flex justify-between items-center px-2">
                        <div class="flex items-center gap-3">
                            <span id="instruction-text" class="bg-slate-100 px-3 py-1 rounded-lg">è¼‰å…¥ä¸­...</span>
                            <div class="flex items-center gap-1.5">
                                <span class="w-3 h-3 bg-purple-500 rounded-full shadow-sm"></span>
                                <span class="text-[11px] normal-case font-black text-purple-600">æˆ‘çš„èª²ç¨‹</span>
                            </div>
                        </div>
                        <span id="mode-badge" class="bg-blue-600 px-4 py-1.5 rounded-full text-white font-black text-[11px] shadow-lg shadow-blue-100"></span>
                    </div>
                    
                    <!-- èª²ç¨‹ä¸»é¡Œé¸æ“‡ (åƒ…é ç´„æ¨¡å¼) -->
                    <div id="course-selector" class="mb-10 hidden px-2">
                        <div id="course-list" class="flex flex-col gap-3"></div>
                    </div>

                    <!-- æœˆæ›†ä¸»é«” (5 æ¬„ï¼šä¸€äºŒä¸‰å››äº”) -->
                    <div id="calendar" class="grid grid-cols-5 gap-3 text-center"></div>
                    
                    <!-- æ¯æ—¥æ™‚æ®µç´°ç¯€ -->
                    <div id="day-detail" class="mt-12 pt-10 border-t-2 border-slate-50 hidden">
                        <div class="flex justify-between items-end mb-8 px-2">
                            <div>
                                <p class="text-xs font-black text-blue-500 uppercase tracking-widest mb-1">Schedule Detail</p>
                                <h3 id="selected-date-text" class="text-2xl font-black text-slate-800"></h3>
                            </div>
                            <span class="text-[10px] text-slate-300 font-bold">é»æ“Šæ™‚æ®µé€²è¡Œæ“ä½œ</span>
                        </div>
                        <div id="time-slots" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸå½ˆçª— -->
    <div id="modal-success" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-6 z-[70] backdrop-blur-md">
        <div class="bg-white rounded-[3rem] p-12 w-full max-w-sm text-center shadow-2xl scale-110">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 text-3xl shadow-inner">âœ“</div>
            <h3 class="text-2xl font-black mb-4 text-slate-800">è™•ç†æˆåŠŸ</h3>
            <p id="success-msg" class="text-slate-500 mb-10 text-base leading-relaxed font-medium"></p>
            <button onclick="closeSuccessModal()" class="w-full py-5 rounded-[2rem] font-black bg-slate-900 text-white shadow-xl active:scale-95 transition-all">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxFbGlBmLjPBwUpnQY-NPAvz3tzsi7pCZKkiyZYeE3-Z25xtiNEKsQTjBtJp0ocp71NGg/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        
        let state = { 
            userId: null, name: '', rawName: '', action: 'view', allEvents: [], 
            course: null, userCourses: [], selectedDate: null 
        };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.userId = profile.userId;
                const params = new URLSearchParams(window.location.search);
                state.action = params.get('action') || 'view';

                await refreshData();

                if (!state.name || state.name === 'è¨ªå®¢' || state.name === "") {
                    await showBindingView();
                } else {
                    showMainView();
                }
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            const [userRes, eventRes] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                fetch(`${GAS_URL}?action=getAllEvents`)
            ]);
            const userData = await userRes.json();
            state.allEvents = await eventRes.json();
            state.rawName = (userData.name || 'è¨ªå®¢').trim();
            state.name = state.rawName.replace(/\s+/g, '').replace(/é†«å¸«/g, '');
            state.userCourses = (userData.courses || []).map(c => c ? c.trim() : "").filter(c => c !== "");
        }

        async function showBindingView() {
            document.getElementById('loading').classList.remove('hidden');
            const res = await fetch(`${GAS_URL}?action=getAllUserNames`);
            const names = await res.json();
            const list = document.getElementById('binding-list');
            list.innerHTML = '';
            names.forEach(n => {
                const btn = document.createElement('button');
                btn.className = "w-full p-6 bg-white border-2 border-slate-100 rounded-[2rem] font-black text-slate-700 shadow-sm active:bg-blue-50 active:border-blue-300 active:scale-95 transition-all text-left flex justify-between items-center";
                btn.innerHTML = `<span class="text-lg">æˆ‘æ˜¯ ${n} é†«å¸«</span> <span class="bg-blue-600 text-white px-5 py-2 rounded-full text-xs shadow-md">ç¶å®š</span>`;
                btn.onclick = () => doBind(n);
                list.appendChild(btn);
            });
            document.getElementById('view-binding').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        async function doBind(name) {
            if(!confirm(`ç¢ºå®šè¦å°‡èº«åˆ†ç¶å®šç‚ºã€Œ${name}ã€å—ï¼Ÿ`)) return;
            document.getElementById('loading').classList.remove('hidden');
            const res = await fetch(`${GAS_URL}?action=bindUser&userId=${state.userId}&name=${encodeURIComponent(name)}`);
            const result = await res.json();
            if(result.status === 'success') location.reload();
        }

        function showMainView() {
            document.getElementById('user-info').textContent = `${state.rawName} é†«å¸«`;
            setupModeUI();
            renderCalendar();
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function setupModeUI() {
            const title = document.getElementById('page-title');
            const badge = document.getElementById('mode-badge');
            const inst = document.getElementById('instruction-text');
            if (state.action === 'book') { 
                title.textContent = "é ç´„æ–°èª²ç¨‹"; badge.textContent = "é ç´„æ’èª²"; 
                document.getElementById('course-selector').classList.remove('hidden'); 
                renderCourseButtons(); inst.textContent = "è«‹é¸èª²ç¨‹å¾Œé»æ—¥æœŸ"; 
            } else if (state.action === 'modify') { 
                title.textContent = "èª²ç¨‹æ›´å‹•èˆ‡å–æ¶ˆ"; badge.textContent = "ä¿®æ”¹æ¨¡å¼"; 
                inst.textContent = "é»æ“Šç´«è‰²æ¨™ç±¤å–æ¶ˆ"; 
            } else { 
                title.textContent = "å…¨é™¢èª²è¡¨æŸ¥è©¢"; badge.textContent = "ç€è¦½æ¨¡å¼"; 
                inst.textContent = "é»æ“Šæ ¼å­çœ‹è©³æƒ…"; 
            }
        }

        function renderCourseButtons() {
            const container = document.getElementById('course-list');
            container.innerHTML = '';
            state.userCourses.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "p-5 border-2 border-slate-100 rounded-[1.5rem] text-sm font-black transition-all text-slate-400 bg-slate-50 text-left flex justify-between items-center shadow-sm";
                btn.innerHTML = `<span>æˆèª²ä¸»é¡Œï¼š${c}</span><span class="w-5 h-5 border-2 border-slate-200 rounded-full flex-shrink-0"></span>`;
                btn.onclick = () => {
                    state.course = c;
                    container.querySelectorAll('button').forEach(b => {
                        b.classList.replace('border-blue-500', 'border-slate-100');
                        b.classList.replace('text-blue-600', 'text-slate-400');
                        b.querySelector('span:last-child').innerHTML = '';
                    });
                    btn.classList.replace('border-slate-100', 'border-blue-500');
                    btn.classList.add('text-blue-600');
                    btn.querySelector('span:last-child').innerHTML = '<div class="w-full h-full bg-blue-500 rounded-full scale-75"></div>';
                };
                container.appendChild(btn);
            });
        }

        function parseEventTitle(title) {
            const match = title.match(/(.*)\((.*)\)/);
            if (match) {
                let p1 = match[1].trim(); let p2 = match[2].trim();
                const cp1 = p1.replace(/\s+/g, '').replace(/é†«å¸«/g, '');
                const cp2 = p2.replace(/\s+/g, '').replace(/é†«å¸«/g, '');
                const isMine = (cp1 === state.name || cp2 === state.name);
                const p1IsDoc = p1.includes('é†«å¸«') || cp1 === state.name;
                let doc = p1IsDoc ? p1 : p2; let course = p1IsDoc ? p2 : p1;
                if (!doc.includes('é†«å¸«')) doc += 'é†«å¸«';
                return { display: `${doc}(${course})`, isMine: isMine };
            }
            return { display: title.trim(), isMine: false };
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            
            // æ¨™é ­æ”¾å¤§ (åƒ… ä¸€~äº”)
            ['ä¸€','äºŒ','ä¸‰','å››','äº”'].forEach(w => {
                const h = document.createElement('div');
                h.className = "text-slate-400 py-6 font-black text-lg tracking-[0.2em]";
                h.textContent = w;
                container.appendChild(h);
            });

            const today = new Date();
            const currentDay = today.getDay(); 
            const diffToMonday = (currentDay === 0 ? -6 : 1 - currentDay);
            const startMonday = new Date(today);
            startMonday.setDate(today.getDate() + diffToMonday);

            // ç”¢ç”Ÿ 5 é€±çš„å…§å®¹ (ç§»é™¤é€±æœ«)
            for (let week = 0; week < 5; week++) {
                for (let day = 0; day < 5; day++) { 
                    const d = new Date(startMonday);
                    d.setDate(startMonday.getDate() + (week * 7) + day);
                    const dateStr = d.toISOString().split('T')[0];
                    const events = state.allEvents.filter(e => e.start.startsWith(dateStr));
                    
                    const el = document.createElement('div');
                    el.dataset.date = dateStr;
                    el.className = `day-cell ${dateStr === today.toISOString().split('T')[0] ? 'is-today' : ''}`;
                    
                    // æ—¥æœŸæ•¸å­—æ¥µè‡´æ”¾å¤§
                    el.innerHTML = `<span class="text-2xl mb-4 font-black text-slate-800">${d.getDate()}</span>`;
                    
                    if (events.length > 0) {
                        events.forEach(e => {
                            const info = parseEventTitle(e.title);
                            const eventClass = info.isMine ? 'my-event-bg' : 'bg-blue-100 text-blue-700';
                            el.innerHTML += `<div class="event-label ${eventClass}">${new Date(e.start).getHours()}h ${info.display}</div>`;
                        });
                    }
                    el.onclick = () => handleDateClick(d, el, events);
                    container.appendChild(el);
                }
            }
        }

        function handleDateClick(date, el, events) {
            state.selectedDate = date;
            showDayDetail(date, el, events);
        }

        function showDayDetail(date, el, events) {
            document.querySelectorAll('.day-cell').forEach(d => d.classList.remove('ring-8', 'ring-blue-500/10', 'z-10', 'scale-105'));
            el.classList.add('ring-8', 'ring-blue-500/10', 'z-10', 'scale-105');
            
            const dateStr = date.toISOString().split('T')[0];
            const detail = document.getElementById('day-detail');
            detail.classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = dateStr + " (é€±" + ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][date.getDay()] + ")";
            
            const tc = document.getElementById('time-slots');
            tc.innerHTML = '';
            
            [9, 10, 11, 13, 14, 15, 16].forEach(h => {
                const booked = events.find(e => new Date(e.start).getHours() === h);
                const info = booked ? parseEventTitle(booked.title) : null;
                const isMine = info ? info.isMine : false;
                const row = document.createElement('div');
                
                const rowClass = booked ? (isMine ? 'my-event-border ring-2 ring-purple-100' : 'border-blue-100 bg-blue-50/20') : 'border-slate-100 bg-white hover:border-blue-200';
                row.className = `w-full p-7 rounded-[2.5rem] border-2 flex justify-between items-center font-black transition-all ${rowClass}`;
                
                let actionBtn = '', infoLabel = `<span class="text-slate-400 text-lg">${h}:00 <span class="font-normal text-sm ml-2">ç©ºé–’æ™‚æ®µ</span></span>`;
                
                if (state.action === 'book') {
                    if (booked) { 
                        infoLabel = `<span class="${isMine ? 'my-event-text' : 'text-slate-800'} text-lg">${h}:00 ${info.display}</span>`; 
                        actionBtn = `<span class="bg-slate-100 text-slate-400 px-4 py-1.5 rounded-full text-xs">å·²è¢«é ç´„</span>`; 
                    } else { 
                        actionBtn = `<button onclick="doBooking('${dateStr}T${String(h).padStart(2,'0')}:00:00')" class="bg-blue-600 text-white px-8 py-3 rounded-2xl text-sm shadow-lg shadow-blue-100 active:scale-90 transition-all">ç«‹å³é ç´„</button>`; 
                    }
                } else if (state.action === 'modify') {
                    if (booked) {
                        infoLabel = `<span class="${isMine ? 'my-event-text' : 'text-slate-800'} text-lg">${h}:00 ${info.display}</span>`;
                        if (isMine) actionBtn = `<button onclick="doCancel('${booked.id}')" class="my-event-btn px-8 py-3 rounded-2xl text-sm font-black active:scale-90 transition-all">å–æ¶ˆé ç´„</button>`;
                        else actionBtn = `<span class="bg-slate-50 text-slate-300 px-4 py-1.5 rounded-full text-xs">ä»–äººé ç´„</span>`;
                    } else { 
                        actionBtn = `<span class="text-slate-200 text-sm">ç„¡èª²ç¨‹</span>`; 
                    }
                } else {
                    if (booked) infoLabel = `<span class="${isMine ? 'my-event-text' : 'text-slate-800'} text-lg">${h}:00 ${info.display}</span>`;
                    actionBtn = `<span class="text-slate-400 text-sm font-black">${booked ? (isMine ? 'æˆ‘çš„èª²ç¨‹' : 'å·²æ’èª²') : 'å¯é ç´„'}</span>`;
                }
                row.innerHTML = `${infoLabel} ${actionBtn}`;
                tc.appendChild(row);
            });
            detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function doBooking(startTime) {
            if (!state.course) return alert('è«‹å…ˆåœ¨ä¸Šæ–¹é¸å–æ‚¨çš„æˆèª²ä¸»é¡Œ');
            if (!confirm(`ç¢ºå®šé ç´„ ${startTime.replace('T', ' ')} å—ï¼Ÿ`)) return;
            startLoad();
            const res = await (await fetch(`${GAS_URL}?action=submitBooking&name=${state.rawName}&course=${state.course}&startTime=${startTime}&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess('é ç´„å®Œæˆï¼Œå·²åŒæ­¥è‡³å…¨é™¢æ—¥æ›†ã€‚');
        }

        async function doCancel(eventId) {
            if (!confirm('ç¢ºå®šå–æ¶ˆä¸¦é‡‹æ”¾æ­¤æ•™å­¸æ™‚æ®µå—ï¼Ÿ')) return;
            startLoad();
            const res = await (await fetch(`${GAS_URL}?action=cancelBooking&eventId=${eventId}&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess('èª²ç¨‹å·²æˆåŠŸå–æ¶ˆï¼Œæ™‚æ®µå·²é‡æ–°é‡‹æ”¾ã€‚');
        }

        function startLoad() { document.getElementById('loading').classList.remove('hidden'); }
        function showSuccess(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('success-msg').textContent = msg; document.getElementById('modal-success').classList.replace('hidden', 'flex'); }
        
        async function closeSuccessModal() {
            document.getElementById('modal-success').classList.replace('flex', 'hidden');
            startLoad();
            await refreshData();
            renderCalendar();
            if (state.selectedDate) {
                const dateStr = state.selectedDate.toISOString().split('T')[0];
                const events = state.allEvents.filter(e => e.start.startsWith(dateStr));
                const dayEl = document.querySelector(`.day-cell[data-date="${dateStr}"]`);
                if (dayEl) showDayDetail(state.selectedDate, dayEl, events);
            }
            document.getElementById('loading').classList.add('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
