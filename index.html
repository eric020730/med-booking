<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫影部教學系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .month-separator { grid-column: span 7 / span 7; }
        .calendar-day { min-height: 90px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">
    <div id="app" class="max-w-md mx-auto p-4 pb-24">
        <!-- 載入動畫 -->
        <div id="loading" class="fixed inset-0 bg-white/95 flex items-center justify-center z-50 transition-opacity">
            <div class="text-center">
                <div class="animate-spin rounded-full h-14 w-14 border-b-4 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-slate-500 font-bold tracking-widest">系統資料同步中...</p>
            </div>
        </div>

        <!-- 管理員專用按鈕區 -->
        <div id="admin-panel" class="hidden mb-6">
            <button onclick="openTemplateModal()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-[28px] font-black shadow-xl shadow-amber-200 flex items-center justify-center active:scale-95 transition-all">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                管理員：部署下月模板課程
            </button>
        </div>

        <!-- 頁面內容 -->
        <div id="page-content" class="hidden">
            <header class="bg-white rounded-[32px] p-6 shadow-sm mb-6 border border-slate-100 text-center">
                <h1 id="page-title" class="text-xl font-black text-slate-800">醫影部教學預約系統</h1>
                <div class="flex items-center justify-center mt-2 space-x-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p id="user-display" class="text-blue-600 text-xs font-black uppercase tracking-widest">醫師資料讀取中</p>
                </div>
            </header>

            <!-- 日曆區塊 -->
            <div class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Department Calendar</h2>
                </div>
                
                <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                    <!-- JS 動態渲染星期與日期 -->
                </div>

                <!-- 當日明細 -->
                <div id="day-detail" class="mt-8 pt-8 border-t border-slate-100 hidden">
                    <div class="flex items-center mb-6">
                        <div class="w-1 h-4 bg-blue-600 rounded-full mr-3"></div>
                        <p id="selected-date-text" class="text-sm font-black text-slate-800"></p>
                    </div>
                    <div id="time-slots" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模板部署 Modal -->
    <div id="template-modal" class="fixed inset-0 bg-slate-900/70 hidden items-center justify-center p-6 z-[60] backdrop-blur-md">
        <div class="bg-white rounded-[40px] p-8 w-full max-w-xs shadow-2xl">
            <div class="text-center mb-6">
                <h3 class="text-xl font-black">自動排課助手</h3>
                <p class="text-slate-400 text-[10px] mt-1 leading-relaxed uppercase tracking-widest">Template Deployment</p>
            </div>
            <p class="text-slate-500 text-xs mb-6 text-center leading-relaxed font-medium">請選擇下個月課程開始的<br><span class="text-amber-600 font-black">第一個週一</span></p>
            <div class="space-y-4">
                <input type="date" id="template-start-date" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-slate-100 focus:border-amber-500 focus:ring-0 font-black text-center">
                <button id="btn-do-deploy" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-transform">開始執行部署</button>
                <button onclick="closeTemplateModal()" class="w-full text-slate-400 py-2 text-xs font-bold uppercase tracking-widest">Cancel</button>
            </div>
        </div>
    </div>

    <!-- 成功提示 Modal -->
    <div id="success-modal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-6 z-[100] backdrop-blur-md">
        <div class="bg-white rounded-[40px] p-10 w-full max-w-xs text-center shadow-2xl scale-in-center">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-xl font-black mb-2">作業完成</h3>
            <p id="success-msg" class="text-slate-500 mb-8 text-sm font-medium">資料已同步至雲端。</p>
            <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black tracking-widest">返回系統</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxvwnC7Xwh5VeTsW-p8inr01k_cPg955c-FMU3ezHbFE_WwBqJQLxeq1W2xG3WzCwS7/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        let state = { userId: null, name: '', isAdmin: false, allEvents: [] };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.userId = profile.userId;

                const [userRes, eventRes] = await Promise.all([
                    fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                    fetch(`${GAS_URL}?action=getAllEvents`)
                ]);
                const userData = await userRes.json();
                state.allEvents = await eventRes.json();
                state.name = userData.name || '訪客';
                state.isAdmin = userData.isAdmin;

                // 檢查網址參數或資料權限
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'admin' || state.isAdmin) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                }

                document.getElementById('user-display').textContent = `${state.name} 醫師 ${state.isAdmin ? '(ADMIN)' : ''}`;
                renderCalendar();
                
                document.getElementById('loading').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('page-content').classList.remove('hidden');
                }, 300);
            } catch (e) {
                alert("初始化失敗，請稍後再試");
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            const weeks = ['一','二','三','四','五','六','日'];
            weeks.forEach(w => {
                container.innerHTML += `<div class="text-slate-300 font-black text-[10px] py-3">${w}</div>`;
            });
            
            const today = new Date();
            const startOffset = (today.getDay() + 6) % 7;
            for (let i = 0; i < startOffset; i++) container.innerHTML += `<div></div>`;

            let lastMonth = today.getMonth();
            for (let i = 0; i < 35; i++) { // 渲染未來 5 週
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                
                if (i > 0 && d.getMonth() !== lastMonth) {
                    container.innerHTML += `<div class="month-separator flex items-center justify-center py-6">
                        <div class="h-[1px] bg-slate-100 flex-1"></div>
                        <span class="mx-4 text-slate-400 font-black text-[9px] tracking-[0.3em] uppercase">${d.getMonth() + 1}月份</span>
                        <div class="h-[1px] bg-slate-100 flex-1"></div>
                    </div>`;
                    const offset = (d.getDay() + 6) % 7;
                    for (let j = 0; j < offset; j++) container.innerHTML += `<div></div>`;
                }
                lastMonth = d.getMonth();

                const dateStr = d.toISOString().split('T')[0];
                const dayEvents = state.allEvents.filter(e => e.start.startsWith(dateStr));
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;

                let html = `<div onclick="selectDate('${dateStr}', this)" class="calendar-day p-1 border border-transparent rounded-2xl font-black transition-all flex flex-col items-center ${isWeekend ? 'bg-slate-50 text-slate-200' : 'bg-white shadow-sm hover:border-blue-100 cursor-pointer'}">`;
                html += `<span class="text-[10px] my-1">${d.getDate()}</span>`;
                
                dayEvents.sort((a,b) => new Date(a.start) - new Date(b.start)).forEach(ev => {
                    const h = new Date(ev.start).getHours();
                    const doc = ev.title.match(/\((.*?)\)/)?.[1]?.replace('醫師','') || "DR";
                    html += `<div class="text-[7px] leading-tight bg-blue-50 text-blue-600 px-1 py-0.5 rounded-md mb-0.5 w-full truncate font-bold">${h}h ${doc}</div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            }
        }

        function selectDate(dateStr, el) {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50/30'));
            el.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50/30');
            const detail = document.getElementById('day-detail');
            detail.classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = dateStr + " 時段現況";
            
            const slots = document.getElementById('time-slots');
            slots.innerHTML = '';
            const hours = [9, 10, 11, 13, 14, 15, 16];
            const events = state.allEvents.filter(e => e.start.startsWith(dateStr));

            hours.forEach(h => {
                const booked = events.find(e => new Date(e.start).getHours() === h);
                slots.innerHTML += `
                    <div class="p-4 rounded-2xl border-2 flex justify-between items-center transition-all ${booked ? 'border-blue-100 bg-blue-50/30' : 'border-slate-50 border-dashed text-slate-300'}">
                        <span class="font-black text-xs">${h}:00</span>
                        <div class="flex items-center">
                            <span class="text-[10px] font-bold mr-2">${booked ? booked.title : 'AVAILABLE'}</span>
                            <div class="w-1.5 h-1.5 rounded-full ${booked ? 'bg-blue-500' : 'bg-slate-200'}"></div>
                        </div>
                    </div>
                `;
            });
            setTimeout(() => detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
        }

        function openTemplateModal() { document.getElementById('template-modal').classList.replace('hidden', 'flex'); }
        function closeTemplateModal() { document.getElementById('template-modal').classList.replace('flex', 'hidden'); }

        document.getElementById('btn-do-deploy').onclick = async () => {
            const startDate = document.getElementById('template-start-date').value;
            if (!startDate) return alert('請選擇起始日期');
            if (new Date(startDate).getDay() !== 1) return alert('請務必選擇該週的「週一」！');

            if (!confirm('系統將根據 <課程模板> 自動產生整月課程並同步至 Google 日曆，確定執行？')) return;

            document.getElementById('loading').classList.remove('hidden', 'opacity-0');
            closeTemplateModal();

            try {
                const res = await fetch(`${GAS_URL}?action=deployTemplate&startDate=${startDate}`);
                const result = await res.json();
                if (result.status === 'success') {
                    document.getElementById('success-msg').textContent = `已成功為您部署 ${result.count} 堂模板課程。`;
                    document.getElementById('success-modal').classList.replace('hidden', 'flex');
                } else {
                    alert("部署失敗：" + result.message);
                }
            } catch (e) { 
                alert('網路連線失敗，請檢查權限設定'); 
            } finally { 
                document.getElementById('loading').classList.add('hidden'); 
            }
        };

        window.onload = init;
    </script>
</body>
</html>
