<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫影部教學系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-cell { min-height: 80px; }
        .month-separator { grid-column: span 7; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <div id="app" class="max-w-md mx-auto p-4 pb-24">
        <!-- 載入動畫 -->
        <div id="loading" class="fixed inset-0 bg-white/95 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-slate-500 font-bold">同步中...</p>
            </div>
        </div>

        <div id="page-content" class="hidden">
            <!-- 1. 預約/查詢 視圖 (原本的代碼內容，略) -->
            <div id="view-calendar" class="hidden">...</div>

            <!-- 2. 管理員批次載入視圖 -->
            <div id="view-admin" class="hidden">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    </div>
                    <h1 class="text-xl font-black text-slate-800">批次載入工具</h1>
                    <p class="text-slate-400 text-sm mt-1">根據「課程模板」自動填入 4 週課表</p>
                </div>

                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">第一步：選擇第一週的週一日期</label>
                    <input type="date" id="start-monday" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-slate-700 mb-8 focus:ring-2 focus:ring-blue-500">
                    
                    <button id="btn-run-batch" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black shadow-xl active:scale-95 transition-all">
                        開始預先載入整月課表
                    </button>
                    
                    <p class="text-center text-[10px] text-slate-300 mt-6 leading-relaxed">執行後系統會自動同步 Google 日曆<br>並更新所有醫師的查詢畫面</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功提示 (原本的 modal，略) -->

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxUW6ITFsZVr10gLxqxIoYp33ni3ZggBDmoDWSuRbqPTn5SKTe70KvMk_J3T0-ZsNpz/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        let state = { userId: null, currentAction: null };

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            state.userId = profile.userId;

            const urlParams = new URLSearchParams(window.location.search);
            state.currentAction = urlParams.get('action');

            if (state.currentAction === 'admin') {
                document.getElementById('view-admin').classList.remove('hidden');
                initAdmin();
            } else {
                // 原本的 renderCalendarView 等初始化邏輯
            }
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function initAdmin() {
            document.getElementById('btn-run-batch').onclick = async () => {
                const date = document.getElementById('start-monday').value;
                if (!date) return alert('請先選擇起始週一日期');
                if (!confirm(`系統將根據模板從 ${date} 開始排課 28 天，確定執行？`)) return;

                document.getElementById('loading').classList.remove('hidden');
                const res = await fetch(`${GAS_URL}?action=batchLoadTemplate&startMonday=${date}`);
                const result = await res.json();
                
                document.getElementById('loading').classList.add('hidden');
                if (result.status === 'success') {
                    alert(`✨ 成功！已自動排入 ${result.count} 門課程。`);
                    liff.closeWindow();
                } else {
                    alert('發生錯誤：' + result.message);
                }
            };
        }

        window.onload = init;
    </script>
</body>
</html>
