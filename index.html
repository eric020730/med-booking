<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫影部排課助理</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .month-separator { grid-column: span 7; }
        .btn-main { @apply w-full py-4 rounded-2xl font-bold transition-all active:scale-95 disabled:opacity-50 disabled:scale-100; }
        .btn-primary { @apply btn-main bg-blue-600 text-white shadow-lg shadow-blue-100; }
        .btn-secondary { @apply btn-main bg-slate-100 text-slate-600; }
        .btn-danger { @apply btn-main bg-red-50 text-red-600; }
        .week-highlight { @apply ring-2 ring-blue-500 bg-blue-50 z-10; }
        .day-cell { @apply min-h-[85px] border border-slate-50 rounded-xl p-1 flex flex-col items-center relative transition-all; }
        .is-today { @apply border-blue-500 border-2; }
        
        /* 紫色高亮樣式 (使用者本人的課程) */
        .my-event-bg { @apply bg-purple-100 text-purple-600 !important; }
        .my-event-border { @apply border-purple-200 bg-purple-50 !important; }
        .my-event-text { @apply text-purple-700 !important; }
        .my-event-btn { @apply bg-purple-600 text-white shadow-purple-100 !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
    <div id="app" class="max-w-md mx-auto p-4 pb-40">
        <!-- 讀取遮罩 -->
        <div id="loading" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-slate-500 font-bold text-sm">正在同步系統資料...</p>
        </div>

        <div id="page-content" class="hidden">
            <!-- 頂部標題 -->
            <header class="text-center mb-6 pt-2">
                <h1 id="page-title" class="text-xl font-black tracking-tight text-slate-800">醫影部教學系統</h1>
                <p id="user-info" class="text-blue-600 text-xs font-bold mt-1"></p>
            </header>

            <!-- 管理員操作面板 -->
            <div id="admin-panel" class="fixed bottom-0 left-0 right-0 bg-white p-6 rounded-t-[40px] shadow-[0_-15px_50px_rgba(0,0,0,0.1)] z-40 hidden border-t border-slate-100">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-5">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">目前選取週次</span>
                            <h3 id="selected-week-range" class="font-black text-slate-800 text-lg"></h3>
                        </div>
                        <button onclick="clearSelection()" class="text-xs bg-slate-100 px-3 py-1 rounded-full text-slate-500 font-bold">重選</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="adminBatchAction('single', 1)" class="btn-secondary text-xs py-3">Week 1 課程</button>
                        <button onclick="adminBatchAction('single', 2)" class="btn-secondary text-xs py-3">Week 2 課程</button>
                        <button onclick="adminBatchAction('single', 3)" class="btn-secondary text-xs py-3">Week 3 課程</button>
                        <button onclick="adminBatchAction('single', 4)" class="btn-secondary text-xs py-3">Week 4 課程</button>
                    </div>
                    
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <button onclick="adminBatchAction('four_weeks')" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-bold text-xs shadow-lg shadow-emerald-100">新增四週課程</button>
                            <button onclick="adminBatchAction('delete_four')" class="flex-1 bg-slate-800 text-white py-4 rounded-2xl font-bold text-xs">刪除四週課程</button>
                        </div>
                        <button onclick="adminBatchAction('delete')" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-bold text-xs">刪除單週課程</button>
                    </div>
                </div>
            </div>

            <!-- 主月曆容器 -->
            <div id="calendar-container" class="bg-white rounded-3xl p-5 shadow-sm mb-4">
                <div id="calendar-instruction" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span id="instruction-text">載入中...</span>
                        <div class="flex items-center gap-1 ml-2">
                            <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                            <span class="text-[8px] normal-case">我的課程</span>
                        </div>
                    </div>
                    <span id="mode-badge" class="bg-slate-100 px-2 py-0.5 rounded-md text-slate-500 font-black"></span>
                </div>
                
                <!-- 課程主題選擇 (僅預約模式) -->
                <div id="course-selector" class="mb-6 hidden">
                    <div id="course-list" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div id="calendar" class="grid grid-cols-7 gap-1 text-center text-xs"></div>
                
                <!-- 時段細節 -->
                <div id="day-detail" class="mt-8 pt-6 border-t border-slate-100 hidden">
                    <p id="selected-date-text" class="text-sm font-black text-slate-700 mb-4"></p>
                    <div id="time-slots" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功彈窗 -->
    <div id="modal-success" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-6 z-[70] backdrop-blur-sm">
        <div class="bg-white rounded-[40px] p-10 w-full max-w-xs text-center shadow-2xl">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">✓</div>
            <h3 class="text-xl font-black mb-2 text-slate-800">課程處理成功</h3>
            <p id="success-msg" class="text-slate-500 mb-8 text-sm leading-relaxed"></p>
            <button onclick="closeSuccessModal()" class="w-full py-4 rounded-2xl font-bold transition-all active:scale-95 bg-white text-slate-900 border border-slate-200">留在管理分頁</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbweig_n3le6_bNDdTto5SFzlKK7j80Wh-0LJ_VOMcFhugSxg41T81Wl_mCr2qwVCZ9aQQ/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        
        let state = { 
            userId: null, 
            name: '', 
            action: 'view', 
            allEvents: [], 
            course: null,
            selectedMonday: null,
            userCourses: []
        };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.userId = profile.userId;

                const params = new URLSearchParams(window.location.search);
                state.action = params.get('action') || 'view';

                await refreshData();

                setupModeUI();
                renderCalendar();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('page-content').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            const [userRes, eventRes] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                fetch(`${GAS_URL}?action=getAllEvents`)
            ]);
            const userData = await userRes.json();
            state.allEvents = await eventRes.json();
            state.name = userData.name || '訪客';
            state.userCourses = userData.courses || [];
            document.getElementById('user-info').textContent = `${state.name} 醫師`;
        }

        function setupModeUI() {
            const title = document.getElementById('page-title');
            const inst = document.getElementById('instruction-text');
            const badge = document.getElementById('mode-badge');
            
            switch(state.action) {
                case 'admin':
                    title.textContent = "排課管理控制台";
                    inst.textContent = "請點選任一天來選取該週範圍";
                    badge.textContent = "管理模式";
                    break;
                case 'book':
                    title.textContent = "預約新課程";
                    inst.textContent = "1. 選主題 2. 點日期";
                    badge.textContent = "預約模式";
                    document.getElementById('course-selector').classList.remove('hidden');
                    renderCourseButtons();
                    break;
                case 'modify':
                    title.textContent = "課程更動與取消";
                    inst.textContent = "點擊紫色課程進行管理";
                    badge.textContent = "修改模式";
                    break;
                default:
                    title.textContent = "醫影部課表查詢";
                    inst.textContent = "點擊日期查看時段";
                    badge.textContent = "查詢模式";
            }
        }

        function renderCourseButtons() {
            const container = document.getElementById('course-list');
            container.innerHTML = '';
            state.userCourses.filter(c => c && c.trim() !== "").forEach(c => {
                const btn = document.createElement('button');
                btn.className = "p-3 border-2 border-slate-100 rounded-2xl text-[10px] font-black transition-all text-slate-400 bg-slate-50";
                btn.textContent = c;
                btn.onclick = () => {
                    state.course = c;
                    container.querySelectorAll('button').forEach(b => b.classList.replace('border-blue-500', 'border-slate-100'));
                    btn.classList.replace('border-slate-100', 'border-blue-500');
                    btn.classList.add('text-blue-600', 'bg-blue-50');
                };
                container.appendChild(btn);
            });
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            const weekDays = ['一','二','三','四','五','六','日'];
            weekDays.forEach(w => {
                const h = document.createElement('div');
                h.className = "text-slate-300 py-3 font-bold text-[10px]";
                h.textContent = w;
                container.appendChild(h);
            });

            const today = new Date();
            const startOffset = (today.getDay() + 6) % 7;
            for (let i = 0; i < startOffset; i++) container.appendChild(document.createElement('div'));

            for (let i = 0; i < 42; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const events = state.allEvents.filter(e => e.start.startsWith(dateStr));

                const el = document.createElement('div');
                el.dataset.date = dateStr;
                el.className = `day-cell ${isWeekend ? 'bg-slate-50 text-slate-200' : 'bg-white cursor-pointer hover:bg-slate-50'}`;
                el.innerHTML = `<span class="text-[10px] mb-2 font-black">${d.getDate()}</span>`;
                
                if (events.length > 0 && !isWeekend) {
                    events.forEach(e => {
                        const h = new Date(e.start).getHours();
                        const doc = e.title.split('(')[1]?.replace(')','') || '';
                        
                        // 辨識是否為自己的課程：檢查標題是否包含 (我的姓名)
                        const isMyEvent = e.title.includes(`(${state.name})`);
                        const eventClass = isMyEvent ? 'my-event-bg' : 'bg-blue-100 text-blue-600';
                        
                        el.innerHTML += `<div class="text-[7px] leading-tight rounded-md px-1 py-0.5 mb-0.5 w-full truncate text-left font-black ${eventClass}">${h}h ${doc}</div>`;
                    });
                }
                el.onclick = () => handleDateClick(d, el, events);
                container.appendChild(el);
            }
        }

        function handleDateClick(date, el, events) {
            if (state.action === 'admin') {
                selectWeek(date);
            } else {
                showDayDetail(date, el, events);
            }
        }

        function selectWeek(date) {
            const monday = new Date(date);
            monday.setDate(date.getDate() - (date.getDay() === 0 ? 6 : date.getDay() - 1));
            state.selectedMonday = monday;

            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            document.querySelectorAll('.day-cell').forEach(cell => {
                const cellDate = new Date(cell.dataset.date);
                if (cellDate >= monday && cellDate <= sunday) {
                    cell.classList.add('week-highlight');
                } else {
                    cell.classList.remove('week-highlight');
                }
            });

            const panel = document.getElementById('admin-panel');
            document.getElementById('selected-week-range').textContent = `${monday.getMonth()+1}/${monday.getDate()} - ${sunday.getMonth()+1}/${sunday.getDate()}`;
            panel.classList.remove('hidden');
        }

        function clearSelection() {
            state.selectedMonday = null;
            document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('week-highlight'));
            document.getElementById('admin-panel').classList.add('hidden');
        }

        function showDayDetail(date, el, events) {
            document.querySelectorAll('.day-cell').forEach(d => d.classList.remove('ring-4', 'ring-blue-500/30', 'z-10'));
            el.classList.add('ring-4', 'ring-blue-500/30', 'z-10');
            
            const dateStr = date.toISOString().split('T')[0];
            const detail = document.getElementById('day-detail');
            detail.classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = dateStr + " 時段清單";
            
            const tc = document.getElementById('time-slots');
            tc.innerHTML = '';
            [9, 10, 11, 13, 14, 15, 16].forEach(h => {
                const booked = events.find(e => new Date(e.start).getHours() === h);
                const isMyEvent = booked && booked.title.includes(`(${state.name})`);
                
                const row = document.createElement('div');
                // 背景色判斷：若為本人課程套用紫色邊框
                const rowClass = booked ? (isMyEvent ? 'my-event-border' : 'border-blue-100 bg-blue-50/30') : 'border-slate-50 bg-white';
                row.className = `w-full p-5 rounded-3xl border-2 flex justify-between items-center font-black text-sm ${rowClass}`;
                
                let actionBtn = '';
                let infoLabel = `<span>${h}:00 時段</span>`;

                if (state.action === 'book') {
                    if (!booked) actionBtn = `<button onclick="doBooking('${dateStr}T${String(h).padStart(2,'0')}:00:00')" class="text-white bg-blue-600 px-5 py-2 rounded-xl text-xs shadow-lg shadow-blue-100">預約</button>`;
                    else actionBtn = `<span class="text-slate-300 text-[10px]">已被預約</span>`;
                } else if (state.action === 'modify') {
                    if (booked) {
                        infoLabel = `<span class="${isMyEvent ? 'my-event-text' : 'text-slate-800'} text-xs">${h}:00 ${booked.title}</span>`;
                        // 權限判斷：僅本人的課程顯示取消按鈕
                        if (isMyEvent) {
                            actionBtn = `<button onclick="doCancel('${booked.id}')" class="my-event-btn px-5 py-2 rounded-xl text-xs font-black">取消</button>`;
                        } else {
                            actionBtn = `<span class="text-slate-300 text-[10px]">他人課程</span>`;
                        }
                    } else {
                        actionBtn = `<span class="text-slate-200 text-[10px]">無課程</span>`;
                    }
                } else {
                    // 查詢模式
                    if (booked) {
                        infoLabel = `<span class="${isMyEvent ? 'my-event-text' : 'text-slate-800'} text-xs">${h}:00 ${booked.title}</span>`;
                    }
                    actionBtn = `<span class="text-slate-400 text-[10px] font-bold">${booked ? (isMyEvent ? '我的課程' : '已排課') : '尚無課程'}</span>`;
                }

                row.innerHTML = `${infoLabel} ${actionBtn}`;
                tc.appendChild(row);
            });
            detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function doBooking(startTime) {
            if (!state.course) return alert('請先選取主題');
            if (!confirm(`確定預約 ${startTime.replace('T', ' ')} 嗎？`)) return;
            startLoad();
            const res = await (await fetch(`${GAS_URL}?action=submitBooking&name=${state.name}&course=${state.course}&startTime=${startTime}&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess('個人課程預約已完成。');
        }

        async function doCancel(eventId) {
            if (!confirm('確定取消這堂課嗎？')) return;
            startLoad();
            const res = await (await fetch(`${GAS_URL}?action=cancelBooking&eventId=${eventId}&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess('預約取消成功。');
        }

        async function adminBatchAction(type, tplIdx = null) {
            if (!state.selectedMonday) return;
            const mondayStr = state.selectedMonday.toISOString().split('T')[0];
            
            let url = `${GAS_URL}?action=`;
            if (type === 'four_weeks') {
                if (!confirm('將從選取週開始連續套用 Week 1-4 模板，確定執行？')) return;
                url += `batchSchedule&type=four_weeks&startDate=${mondayStr}`;
            } else if (type === 'delete_four') {
                if (!confirm('將從選取週開始「連續刪除四週」的所有課程紀錄，確定？')) return;
                const weeks = [];
                for(let i=0; i<4; i++) {
                    const d = new Date(state.selectedMonday);
                    d.setDate(state.selectedMonday.getDate() + (i * 7));
                    weeks.push(d.toISOString().split('T')[0]);
                }
                url += `batchDelete&weeks=${weeks.join(',')}`;
            } else if (type === 'single') {
                url += `batchSchedule&type=single&startDate=${mondayStr}&templateIdx=${tplIdx}`;
            } else {
                if (!confirm('確定刪除該週所有課程紀錄嗎？')) return;
                url += `batchDelete&weeks=${mondayStr}`;
            }
            url += `&userId=${state.userId}`;

            startLoad();
            const res = await (await fetch(url)).json();
            if (res.status === 'success') showSuccess(res.message);
        }

        function startLoad() { document.getElementById('loading').classList.remove('hidden'); }
        
        function showSuccess(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('success-msg').textContent = msg;
            document.getElementById('modal-success').classList.replace('hidden', 'flex');
        }

        async function closeSuccessModal() {
            document.getElementById('modal-success').classList.replace('flex', 'hidden');
            startLoad();
            await refreshData();
            renderCalendar();
            document.getElementById('loading').classList.add('hidden');
            if (state.selectedMonday) selectWeek(state.selectedMonday);
        }

        window.onload = init;
    </script>
</body>
</html>
