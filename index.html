<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å½±éƒ¨æ’èª²åŠ©ç†</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .month-separator { grid-column: span 7; }
        .admin-card { @apply bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-4; }
        .btn-main { @apply w-full py-4 rounded-2xl font-bold transition-all active:scale-95; }
        .btn-primary { @apply btn-main bg-blue-600 text-white shadow-lg shadow-blue-100; }
        .btn-danger { @apply btn-main bg-red-50 text-red-600; }
        .dot { height: 4px; width: 4px; background-color: #3b82f6; border-radius: 50%; display: inline-block; margin-top: 2px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
    <div id="app" class="max-w-md mx-auto p-4 pb-20">
        <!-- è®€å–ä¸­é®ç½© -->
        <div id="loading" class="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-slate-500 font-medium">ç³»çµ±åŒæ­¥ä¸­...</p>
        </div>

        <div id="page-content" class="hidden">
            <!-- æ¨™é¡Œ -->
            <header class="text-center mb-6">
                <h1 id="page-title" class="text-xl font-black">é†«å½±éƒ¨æ•™å­¸ç³»çµ±</h1>
                <p id="user-info" class="text-blue-600 text-sm font-bold mt-1"></p>
            </header>

            <!-- 1. ç®¡ç†å“¡æ¨¡å¼ (action=admin) -->
            <div id="view-admin" class="hidden space-y-4">
                <div class="admin-card">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center mr-3">ğŸ“…</div>
                        <div>
                            <h2 class="font-bold">åŠŸèƒ½ä¸€ï¼šè‡ªå‹•ç™¼ä½ˆ</h2>
                            <p class="text-[10px] text-slate-400">ä¾æ¨¡æ¿å¡«å…¥ä¸‹å€‹æœˆå››é€±èª²ç¨‹</p>
                        </div>
                    </div>
                    <button onclick="adminAction('auto')" class="btn-primary">å•Ÿå‹•è‡ªå‹•æ’èª²</button>
                </div>

                <div class="admin-card">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center mr-3">ğŸ“</div>
                        <div>
                            <h2 class="font-bold">åŠŸèƒ½äºŒï¼šæŒ‡å®šé€±æ¬¡è¼‰å…¥</h2>
                            <p class="text-[10px] text-slate-400">é¸æ“‡æ—¥æœŸä¸¦å¥—ç”¨ç‰¹å®šæ¨¡æ¿é€±</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <input type="date" id="admin-date" class="w-full p-3 bg-slate-50 border-0 rounded-xl font-bold">
                        <select id="admin-tpl-idx" class="w-full p-3 bg-slate-50 border-0 rounded-xl font-bold">
                            <option value="1">å¥—ç”¨æ¨¡æ¿ï¼šç¬¬ 1 é€±</option>
                            <option value="2">å¥—ç”¨æ¨¡æ¿ï¼šç¬¬ 2 é€±</option>
                            <option value="3">å¥—ç”¨æ¨¡æ¿ï¼šç¬¬ 3 é€±</option>
                            <option value="4">å¥—ç”¨æ¨¡æ¿ï¼šç¬¬ 4 é€±</option>
                        </select>
                        <button onclick="adminAction('single')" class="btn-primary bg-emerald-600 shadow-emerald-100">è¼‰å…¥è©²é€±èª²ç¨‹</button>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-red-100 text-red-600 rounded-xl flex items-center justify-center mr-3">ğŸ—‘ï¸</div>
                        <div>
                            <h2 class="font-bold">åŠŸèƒ½ä¸‰ï¼šæ‰¹æ¬¡åˆªé™¤</h2>
                            <p class="text-[10px] text-slate-400">ä»¥ã€Œé€±ã€ç‚ºå–®ä½æ¸…é™¤èª²ç¨‹</p>
                        </div>
                    </div>
                    <div id="delete-weeks-container" class="space-y-2 mb-4"></div>
                    <button id="btn-batch-delete" onclick="adminAction('delete')" disabled class="btn-primary bg-slate-900 shadow-slate-200">åˆªé™¤å‹¾é¸é€±æ¬¡</button>
                </div>
            </div>

            <!-- 2. ä½¿ç”¨è€…æ¨¡å¼ (é ç´„/æŸ¥è©¢) -->
            <div id="view-calendar" class="hidden">
                <div id="course-selector" class="bg-white rounded-3xl p-6 shadow-sm mb-4 hidden">
                    <h2 class="text-xs font-bold text-slate-400 uppercase mb-4">1. é¸æ“‡é ç´„ä¸»é¡Œ</h2>
                    <div id="course-list" class="space-y-2"></div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div id="calendar-header-text" class="text-xs font-bold text-slate-400 uppercase mb-4">å…¨é«”èª²è¡¨ç‹€æ³</div>
                    <div id="calendar" class="grid grid-cols-7 gap-1 text-center text-xs"></div>
                    
                    <div id="day-detail" class="mt-6 pt-6 border-t border-slate-100 hidden">
                        <p id="selected-date-text" class="text-sm font-black text-slate-700 mb-4"></p>
                        <div id="time-slots" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- 3. ä¿®æ”¹æ¨¡å¼ -->
            <div id="view-modify" class="hidden space-y-3">
                <div id="record-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤º Modal -->
    <div id="modal-success" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-6 z-[70] backdrop-blur-sm">
        <div class="bg-white rounded-[40px] p-10 w-full max-w-xs text-center shadow-2xl">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">âœ“</div>
            <h3 class="text-xl font-black mb-2">è™•ç†æˆåŠŸ</h3>
            <p id="success-msg" class="text-slate-500 mb-8 text-sm"></p>
            <button onclick="liff.closeWindow()" class="btn-primary bg-slate-900">è¿”å› LINE</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxAXdN7IlN1wBzgTCLPwXSa-Bcn4ooONu2rPIOMtJgUajuGUuAN7a956VEL_st3QKEswQ/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        
        let state = { userId: null, name: '', action: 'view', allEvents: [], course: null };

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            state.userId = profile.userId;

            const params = new URLSearchParams(window.location.search);
            state.action = params.get('action') || 'view';

            const [userRes, eventRes] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                fetch(`${GAS_URL}?action=getAllEvents`)
            ]);
            
            const userData = await userRes.json();
            state.allEvents = await eventRes.json();
            state.name = userData.name || 'è¨ªå®¢';
            document.getElementById('user-info').textContent = `${state.name} é†«å¸«`;

            // è·¯ç”±åˆ¤å®šï¼šå·²ç§»é™¤æ¬Šé™åå–®é©—è­‰ï¼Œæ‰€æœ‰äººçš†å¯é€²å…¥ admin æ¨¡å¼
            if (state.action === 'admin') {
                showAdmin();
            } else if (state.action === 'modify') {
                showModify();
            } else {
                showCalendar(state.action === 'book');
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function showAdmin() {
            document.getElementById('page-title').textContent = "ğŸ”§ æ’èª²ç®¡ç†æ§åˆ¶å°";
            document.getElementById('view-admin').classList.remove('hidden');
            const container = document.getElementById('delete-weeks-container');
            container.innerHTML = '';
            
            // æ¸²æŸ“æœªä¾†å…­é€±ä¾›æ‰¹æ¬¡åˆªé™¤é¸æ“‡
            const now = new Date();
            const monday = new Date(now);
            monday.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));

            for (let i = 0; i < 6; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + (i * 7));
                const dStr = d.toISOString().split('T')[0];
                const label = document.createElement('label');
                label.className = "flex items-center p-4 bg-slate-50 rounded-2xl cursor-pointer hover:bg-slate-100 transition-colors";
                label.innerHTML = `
                    <input type="checkbox" name="del-week" value="${dStr}" class="mr-3 w-5 h-5 rounded border-slate-300 text-blue-600" onchange="updateDelBtn()">
                    <span class="text-sm font-bold text-slate-700">ç¬¬ ${i+1} é€± (${d.getMonth()+1}/${d.getDate()} èµ·)</span>
                `;
                container.appendChild(label);
            }
        }

        async function adminAction(type) {
            let url = `${GAS_URL}?action=`;
            if (type === 'auto') {
                if (!confirm('ç¢ºå®šä¾æ¨¡æ¿è‡ªå‹•é æ’ã€Œä¸‹å€‹æœˆã€çš„å®Œæ•´å››é€±èª²ç¨‹å—ï¼Ÿ')) return;
                url += `batchSchedule&type=auto`;
            } else if (type === 'single') {
                const date = document.getElementById('admin-date').value;
                const idx = document.getElementById('admin-tpl-idx').value;
                if (!date) return alert('è«‹å…ˆé¸æ“‡è¦è¼‰å…¥çš„æ—¥æœŸç¯„åœ');
                url += `batchSchedule&type=single&startDate=${date}&templateIdx=${idx}`;
            } else if (type === 'delete') {
                const checked = Array.from(document.querySelectorAll('input[name="del-week"]:checked')).map(i => i.value);
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${checked.length} é€±å…§çš„æ‰€æœ‰èª²ç¨‹å—ï¼Ÿ`)) return;
                url += `batchDelete&weeks=${checked.join(',')}`;
            }
            url += `&userId=${state.userId}`;
            
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await (await fetch(url)).json();
                if (res.status === 'success') {
                    document.getElementById('success-msg').textContent = res.message;
                    document.getElementById('modal-success').classList.replace('hidden', 'flex');
                } else {
                    alert('åŸ·è¡Œå‡ºéŒ¯ï¼š' + res.message);
                }
            } catch (e) {
                alert('åŸ·è¡Œå¤±æ•—ï¼Œè«‹ç¢ºèª GAS URL æ˜¯å¦æ­£ç¢ºã€‚');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function updateDelBtn() {
            const count = document.querySelectorAll('input[name="del-week"]:checked').length;
            document.getElementById('btn-batch-delete').disabled = count === 0;
        }

        // --- ä»¥ä¸‹ç¶­æŒåŸæœ‰æ—¥æ›†é‚è¼¯ ---
        function showCalendar(isBook) {
            document.getElementById('view-calendar').classList.remove('hidden');
            if (isBook) {
                document.getElementById('course-selector').classList.remove('hidden');
                const list = document.getElementById('course-list');
                list.innerHTML = '';
                // æ¨¡æ“¬æŠ“å–é†«å¸«å¯é¸èª²ç¨‹
                const mockCourses = ['èƒ¸éƒ¨å½±åƒå°è®€', 'ä»‹å…¥æ€§æ”¾å°„è¨ºæ–·å­¸'];
                mockCourses.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 border-2 border-slate-100 rounded-2xl font-bold transition-all";
                    btn.textContent = c;
                    btn.onclick = () => {
                        state.course = c;
                        list.querySelectorAll('button').forEach(b => b.classList.replace('border-blue-500', 'border-slate-100'));
                        btn.classList.replace('border-slate-100', 'border-blue-500');
                    };
                    list.appendChild(btn);
                });
            }
            renderCalendar(isBook);
        }

        function renderCalendar(isBook) {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            const weekDays = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
            weekDays.forEach(w => {
                const h = document.createElement('div');
                h.className = "text-slate-300 py-2 font-bold";
                h.textContent = w;
                container.appendChild(h);
            });

            const today = new Date();
            const startOffset = (today.getDay() + 6) % 7;
            for (let i = 0; i < startOffset; i++) container.appendChild(document.createElement('div'));

            for (let i = 0; i < 35; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const events = state.allEvents.filter(e => e.start.startsWith(dateStr));

                const el = document.createElement('div');
                el.className = `min-h-[75px] border border-slate-50 rounded-xl p-1 flex flex-col items-center relative ${isWeekend ? 'bg-slate-100/50 text-slate-300' : 'bg-white cursor-pointer hover:bg-slate-50'}`;
                el.innerHTML = `<span class="text-[10px] mb-1 font-bold">${d.getDate()}</span>`;
                
                if (events.length > 0 && !isWeekend) {
                    events.forEach(e => {
                        const h = new Date(e.start).getHours();
                        const doc = e.title.split('(')[1]?.replace(')','') || '';
                        el.innerHTML += `<div class="text-[8px] leading-tight bg-blue-100 text-blue-600 rounded px-1 mb-0.5 w-full truncate text-left font-bold">${h}h ${doc}</div>`;
                    });
                }
                if (!isWeekend) el.onclick = () => selectDate(dateStr, el, events, isBook);
                container.appendChild(el);
            }
        }

        function selectDate(dateStr, el, events, isBook) {
            document.querySelectorAll('#calendar > div').forEach(d => d.classList.remove('ring-2', 'ring-blue-500', 'z-10'));
            el.classList.add('ring-2', 'ring-blue-500', 'z-10');
            const detail = document.getElementById('day-detail');
            detail.classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = dateStr + " æ™‚æ®µç´°ç¯€";
            const tc = document.getElementById('time-slots');
            tc.innerHTML = '';
            const hours = [9, 10, 11, 13, 14, 15, 16];
            hours.forEach(h => {
                const booked = events.find(e => new Date(e.start).getHours() === h);
                const row = document.createElement('button');
                row.className = `w-full p-4 rounded-2xl border-2 flex justify-between items-center font-bold text-sm ${booked ? 'bg-slate-50 border-slate-100 text-slate-300' : 'border-blue-100 text-blue-600 hover:bg-blue-50'}`;
                row.innerHTML = `<span>${h}:00</span> <span>${booked ? 'å·²è¢«é ç´„' : 'âœ… å¯é ç´„'}</span>`;
                if (!booked && isBook) row.onclick = () => submitSingleBooking(dateStr + 'T' + String(h).padStart(2,'0') + ':00:00');
                tc.appendChild(row);
            });
            detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function submitSingleBooking(startTime) {
            if (!state.course) return alert('è«‹å…ˆé¸æ“‡èª²ç¨‹ä¸»é¡Œ');
            if (!confirm(`ç¢ºå®šé ç´„æ–¼ ${startTime.replace('T', ' ')}ï¼Ÿ`)) return;
            document.getElementById('loading').classList.remove('hidden');
            const res = await (await fetch(`${GAS_URL}?action=submitBooking&name=${state.name}&course=${state.course}&startTime=${startTime}&userId=${state.userId}`)).json();
            if (res.status === 'success') {
                document.getElementById('success-msg').textContent = 'é ç´„æˆåŠŸï¼ç³»çµ±å·²ç™¼é€ LINE é€šçŸ¥ã€‚';
                document.getElementById('modal-success').classList.replace('hidden', 'flex');
            }
            document.getElementById('loading').classList.add('hidden');
        }

        async function showModify() {
            document.getElementById('view-modify').classList.remove('hidden');
            document.getElementById('page-title').textContent = "é ç´„ç®¡ç†";
            const res = await (await fetch(`${GAS_URL}?action=getMyBookings&userId=${state.userId}`)).json();
            const list = document.getElementById('record-list');
            list.innerHTML = '';
            if (res.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400 py-10 text-sm">æœªä¾†ä¸€å€‹æœˆå°šç„¡æ‚¨çš„é ç´„ç´€éŒ„</p>';
                return;
            }
            res.forEach(r => {
                const d = new Date(r.time);
                const item = document.createElement('div');
                item.className = "bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center";
                item.innerHTML = `<div><div class="text-slate-800 font-black text-lg">${r.course}</div><div class="text-blue-500 font-bold text-sm">${d.toLocaleDateString()} ${d.getHours()}:00</div></div><button class="text-red-500 font-bold text-sm" onclick="cancelBooking('${r.eventId}')">å–æ¶ˆ</button>`;
                list.appendChild(item);
            });
        }

        async function cancelBooking(eid) {
            if (!confirm('ç¢ºå®šå–æ¶ˆé€™å ‚èª²å—ï¼Ÿ')) return;
            document.getElementById('loading').classList.remove('hidden');
            const res = await (await fetch(`${GAS_URL}?action=cancelBooking&eventId=${eid}&userId=${state.userId}`)).json();
            if (res.status === 'success') location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>
