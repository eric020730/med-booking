<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫影部排課助理</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-main { @apply w-full py-4 rounded-[2rem] font-black transition-all active:scale-95 disabled:opacity-50 disabled:scale-100 shadow-sm text-lg; }
        .btn-primary { @apply btn-main bg-blue-600 text-white shadow-blue-200; }
        .btn-secondary { @apply btn-main bg-slate-100 text-slate-600; }
        
        /* 壓縮格位高度，確保版面緊湊 */
        .day-cell { @apply min-h-[105px] border border-slate-50 rounded-[1.5rem] p-1.5 flex flex-col items-center relative transition-all bg-white cursor-pointer; }
        
        /* 今日標示：維持清晰但尺寸微調 */
        .is-today-dot { @apply bg-blue-600 text-white rounded-full w-9 h-9 flex items-center justify-center font-black mx-auto shadow-md text-base; }
        .is-today-cell { @apply bg-blue-50 border-blue-200 border-2 !important; }
        
        /* 週次標籤側欄縮減寬度 */
        .week-label-col { @apply flex items-center justify-center text-[9px] font-black text-slate-300 writing-mode-vertical; writing-mode: vertical-lr; }
        .week-label-active { @apply text-blue-600 bg-blue-50/40 rounded-lg; }

        /* 課程標籤：強制單行並縮小字體 */
        .course-tag { @apply text-[8px] leading-tight rounded-md px-1 py-0.5 mb-0.5 w-full truncate text-left font-bold; }
        .my-event-bg { background-color: #f3e8ff !important; color: #7e22ce !important; }
        .event-default-bg { background-color: #eff6ff !important; color: #2563eb !important; }
        
        /* 過去課程淡化效果 */
        .past-event { opacity: 0.3 !important; filter: grayscale(0.9) !important; }

        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 antialiased">
    <div id="app" class="max-w-md mx-auto p-3 pb-32">
        <div id="loading" class="fixed inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 mb-4"></div>
            <p class="text-slate-600 font-black">載入中...</p>
        </div>

        <div id="page-content" class="hidden">
            <div id="view-binding" class="hidden space-y-6 pt-10 px-2">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-black text-slate-800">身分辨識</h2>
                    <p class="text-slate-400 text-sm mt-1">請選擇您的姓名以綁定</p>
                </div>
                <div id="binding-list" class="grid grid-cols-1 gap-3 overflow-y-auto max-h-[70vh]"></div>
            </div>

            <div id="view-main" class="hidden">
                <header class="text-center mb-4 pt-2">
                    <h1 id="page-title" class="text-xl font-black text-slate-900">醫影部教學系統</h1>
                    <p id="user-info" class="text-blue-600 text-xs font-black mt-1 bg-blue-50 inline-block px-4 py-1 rounded-full"></p>
                </header>

                <!-- 管理員面板 (浮動於下方) -->
                <div id="admin-panel" class="fixed bottom-0 left-0 right-0 bg-white p-6 rounded-t-[2.5rem] shadow-[0_-15px_40px_rgba(0,0,0,0.08)] z-40 hidden border-t border-slate-100">
                    <div class="max-w-md mx-auto">
                        <div class="flex justify-between items-center mb-4 px-2">
                            <h3 id="selected-week-range" class="font-black text-slate-800 text-lg">請選取日期</h3>
                            <button onclick="clearSelection()" class="text-xs text-slate-400 font-bold underline">重選</button>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            <button onclick="adminBatchAction('single', 1)" class="bg-slate-100 py-3 rounded-xl font-black text-xs">W1</button>
                            <button onclick="adminBatchAction('single', 2)" class="bg-slate-100 py-3 rounded-xl font-black text-xs">W2</button>
                            <button onclick="adminBatchAction('single', 3)" class="bg-slate-100 py-3 rounded-xl font-black text-xs">W3</button>
                            <button onclick="adminBatchAction('single', 4)" class="bg-slate-100 py-3 rounded-xl font-black text-xs">W4</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="adminBatchAction('four_weeks')" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black text-sm">連續排四週</button>
                            <button onclick="adminBatchAction('delete_four')" class="flex-1 bg-slate-800 text-white py-4 rounded-2xl font-black text-sm">連刪四週</button>
                        </div>
                    </div>
                </div>

                <div id="calendar-container" class="bg-white rounded-[2.5rem] p-3 shadow-lg shadow-slate-200/50 border border-slate-100">
                    <div class="text-[10px] font-black text-slate-400 uppercase mb-4 flex justify-between items-center px-1">
                        <span id="mode-badge" class="bg-blue-600 px-3 py-1 rounded-full text-white">模式</span>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2.5 h-2.5 bg-purple-500 rounded-full"></span>
                            <span class="text-purple-600">我的課程</span>
                        </div>
                    </div>
                    
                    <div id="course-selector" class="mb-4 hidden">
                        <div id="course-list" class="grid grid-cols-1 gap-2"></div>
                    </div>

                    <!-- 精簡 6 欄月曆 -->
                    <div id="calendar" class="grid grid-cols-[25px_1fr_1fr_1fr_1fr_1fr] gap-1.5 text-center"></div>
                    
                    <div id="day-detail" class="mt-8 pt-6 border-t border-slate-50 hidden">
                        <h3 id="selected-date-text" class="text-xl font-black text-slate-800 mb-6"></h3>
                        <div id="time-slots" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-success" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-6 z-[70] backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-xl">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">✓</div>
            <p id="success-msg" class="text-slate-600 font-bold mb-8"></p>
            <button onclick="closeSuccessModal()" class="w-full py-4 rounded-2xl font-black bg-slate-900 text-white">確定</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyu0c5Rmhrac2VzL8QV6Rq4IocF4FMI-9t0bDiHLMRLwWArKwTicMK40d4dXYRcfG_dbg/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        
        let state = { userId: null, name: '', rawName: '', action: 'view', allEvents: [], course: null, selectedMonday: null, userCourses: [], selectedDate: null };

        function toLocalISOString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.userId = profile.userId;
                state.action = new URLSearchParams(window.location.search).get('action') || 'view';
                await refreshData();
                if (!state.name || state.name === '訪客') await showBindingView();
                else showMainView();
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            const [userRes, eventRes] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                fetch(`${GAS_URL}?action=getAllEvents`)
            ]);
            const userData = await userRes.json();
            state.allEvents = await eventRes.json();
            state.rawName = (userData.name || '訪客').trim();
            state.name = state.rawName.replace(/\s+/g, '').replace(/醫師/g, '');
            state.userCourses = (userData.courses || []).map(c => c ? c.trim() : "").filter(c => c !== "");
        }

        async function showBindingView() {
            startLoad();
            const res = await fetch(`${GAS_URL}?action=getAllUserNames`);
            const names = await res.json();
            const list = document.getElementById('binding-list');
            list.innerHTML = '';
            names.forEach(n => {
                const btn = document.createElement('button');
                btn.className = "w-full p-5 bg-white border border-slate-100 rounded-2xl font-black text-slate-700 shadow-sm active:bg-blue-50 text-left flex justify-between items-center";
                btn.innerHTML = `<span>我是 ${n} 醫師</span> <span class="bg-blue-600 text-white px-4 py-1.5 rounded-full text-[10px]">綁定</span>`;
                btn.onclick = () => doBind(n);
                list.appendChild(btn);
            });
            document.getElementById('view-binding').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        async function doBind(name) {
            if(!confirm(`確定綁定為「${name}」醫師嗎？`)) return;
            startLoad();
            const res = await fetch(`${GAS_URL}?action=bindUser&userId=${state.userId}&name=${encodeURIComponent(name)}`);
            if((await res.json()).status === 'success') location.reload();
        }

        function showMainView() {
            document.getElementById('user-info').textContent = `${state.rawName} 醫師`;
            setupModeUI();
            renderCalendar();
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function setupModeUI() {
            const badge = document.getElementById('mode-badge');
            if (state.action === 'admin') badge.textContent = "管理模式";
            else if (state.action === 'book') { badge.textContent = "預約模式"; document.getElementById('course-selector').classList.remove('hidden'); renderCourseButtons(); }
            else if (state.action === 'modify') badge.textContent = "修改模式";
            else badge.textContent = "查詢模式";
        }

        function renderCourseButtons() {
            const container = document.getElementById('course-list');
            container.innerHTML = '';
            state.userCourses.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "p-4 border-2 border-slate-100 rounded-2xl text-xs font-black transition-all text-slate-500 bg-slate-50 text-left flex justify-between items-center";
                btn.innerHTML = `<span>主題：${c}</span> <span class="w-4 h-4 border-2 border-slate-200 rounded-full"></span>`;
                btn.onclick = () => {
                    state.course = c;
                    container.querySelectorAll('button').forEach(b => { 
                        b.classList.replace('border-blue-500', 'border-slate-100'); 
                        b.classList.replace('text-blue-600', 'text-slate-500');
                        b.querySelector('span:last-child').classList.remove('bg-blue-600'); 
                    });
                    btn.classList.replace('border-slate-100', 'border-blue-500');
                    btn.classList.add('text-blue-600');
                    btn.querySelector('span:last-child').classList.add('bg-blue-600');
                };
                container.appendChild(btn);
            });
        }

        function parseEventTitle(title) {
            const match = title.match(/(.*)\((.*)\)/);
            if (match) {
                let p1 = match[1].trim(), p2 = match[2].trim();
                const cp1 = p1.replace(/\s+/g, '').replace(/醫師/g, '');
                const cp2 = p2.replace(/\s+/g, '').replace(/醫師/g, '');
                const isMine = (cp1 === state.name || cp2 === state.name);
                const p1IsDoc = p1.includes('醫師') || cp1 === state.name;
                let doc = p1IsDoc ? p1 : p2, course = p1IsDoc ? p2 : p1;
                return { display: `${doc.replace('醫師','')}(${course})`, isMine: isMine };
            }
            return { display: title.trim(), isMine: false };
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            
            container.appendChild(document.createElement('div'));
            ['一','二','三','四','五'].forEach(w => {
                const h = document.createElement('div');
                h.className = "text-slate-300 py-2 font-black text-[10px]";
                h.textContent = w;
                container.appendChild(h);
            });

            const today = new Date();
            today.setHours(0,0,0,0);
            const todayStr = toLocalISOString(today);
            const dayOfWeek = today.getDay();
            const startMonday = new Date(today.getTime() + (dayOfWeek === 0 ? -6 : 1 - dayOfWeek) * 24 * 60 * 60 * 1000);

            for (let week = 0; week < 6; week++) {
                const weekMon = new Date(startMonday.getTime() + (week * 7) * 24 * 60 * 60 * 1000);
                
                const weekLabel = document.createElement('div');
                weekLabel.className = "week-label-col";
                weekLabel.innerHTML = `<span class="opacity-40">W${(week % 4) + 1}</span>`;
                container.appendChild(weekLabel);

                for (let day = 0; day < 5; day++) {
                    const d = new Date(weekMon.getTime() + day * 24 * 60 * 60 * 1000);
                    const dateStr = toLocalISOString(d);
                    const events = state.allEvents.filter(e => toLocalISOString(new Date(e.start)) === dateStr);
                    const isToday = (dateStr === todayStr);
                    const isPast = (d < today);

                    const el = document.createElement('div');
                    el.dataset.date = dateStr;
                    el.className = `day-cell ${isToday ? 'is-today-cell' : ''}`;
                    el.innerHTML = `<div class="mb-2 flex items-center justify-center">
                        <div class="${isToday ? 'is-today-dot' : 'text-slate-800 text-sm font-black'}">${d.getDate()}</div>
                    </div>`;
                    
                    events.forEach(e => {
                        const info = parseEventTitle(e.title);
                        const h = new Date(e.start).getHours();
                        el.innerHTML += `<div class="course-tag ${info.isMine ? 'my-event-bg' : 'event-default-bg'} ${isPast ? 'past-event' : ''}">${h}h ${info.display}</div>`;
                    });

                    el.onclick = () => {
                        if (state.action === 'admin') selectWeek(d);
                        else { state.selectedDate = d; showDayDetail(d, el, events); }
                    };
                    container.appendChild(el);
                }
            }
        }

        function selectWeek(date) {
            const day = date.getDay();
            const monday = new Date(date.getTime() + (day === 0 ? -6 : 1 - day) * 24 * 60 * 60 * 1000);
            const friday = new Date(monday.getTime() + 4 * 24 * 60 * 60 * 1000);
            state.selectedMonday = monday;
            document.querySelectorAll('.day-cell').forEach(cell => {
                const d = new Date(cell.dataset.date);
                cell.classList.toggle('week-highlight', d >= monday && d <= friday);
            });
            document.getElementById('selected-week-range').textContent = `${monday.getMonth()+1}/${monday.getDate()} - ${friday.getMonth()+1}/${friday.getDate()}`;
            document.getElementById('admin-panel').classList.remove('hidden');
        }

        function clearSelection() { state.selectedMonday = null; document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('week-highlight')); document.getElementById('admin-panel').classList.add('hidden'); }

        function showDayDetail(date, el, events) {
            document.querySelectorAll('.day-cell').forEach(d => d.classList.remove('ring-4', 'ring-blue-500/10', 'z-10', 'scale-105'));
            el.classList.add('ring-4', 'ring-blue-500/10', 'z-10', 'scale-105');
            const detail = document.getElementById('day-detail');
            detail.classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = toLocalISOString(date) + " (週" + ['日','一','二','三','四','五','六'][date.getDay()] + ")";
            const tc = document.getElementById('time-slots');
            tc.innerHTML = '';
            [9, 10, 11, 13, 14, 15, 16].forEach(h => {
                const booked = events.find(e => new Date(e.start).getHours() === h);
                const info = booked ? parseEventTitle(booked.title) : null;
                const row = document.createElement('div');
                row.className = `w-full p-6 rounded-3xl border flex justify-between items-center font-black ${booked ? (info.isMine ? 'my-event-border bg-purple-50/30' : 'bg-blue-50/10 border-blue-100') : 'border-slate-100 bg-white'}`;
                
                let content = `<span class="text-slate-400 text-sm">${h}:00 空閒</span>`;
                let action = '';

                if (booked) {
                    content = `<span class="${info.isMine ? 'text-purple-600' : 'text-slate-800'} text-sm">${h}:00 ${info.display}</span>`;
                    if (state.action === 'modify' && info.isMine) action = `<button onclick="doCancel('${booked.id}')" class="text-[10px] bg-purple-600 text-white px-4 py-1.5 rounded-full">取消</button>`;
                    else action = `<span class="text-slate-300 text-[10px]">${info.isMine ? '我的' : '已排'}</span>`;
                } else if (state.action === 'book') {
                    action = `<button onclick="doBooking('${toLocalISOString(date)}T${String(h).padStart(2,'0')}:00:00')" class="text-[10px] bg-blue-600 text-white px-4 py-1.5 rounded-full">預約</button>`;
                }

                row.innerHTML = `<div>${content}</div> ${action}`;
                tc.appendChild(row);
            });
            detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function doBooking(startTime) {
            if (!state.course) return alert('請先選取主題');
            if (!confirm('確定預約嗎？')) return;
            startLoad();
            const res = await (await fetch(`${GAS_URL}?action=submitBooking&name=${encodeURIComponent(state.rawName)}&course=${encodeURIComponent(state.course)}&startTime=${startTime}&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess('預約成功');
        }

        async function doCancel(eventId) {
            if (!confirm('確定取消嗎？')) return;
            startLoad();
            const res = await (await fetch(`${GAS_URL}?action=cancelBooking&eventId=${eventId}&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess('已取消');
        }

        async function adminBatchAction(type, tplIdx = null) {
            if (!state.selectedMonday) return;
            startLoad();
            const mondayStr = toLocalISOString(state.selectedMonday);
            let url = `${GAS_URL}?action=`;
            if (type === 'four_weeks') url += `batchSchedule&type=four_weeks&startDate=${mondayStr}`;
            else if (type === 'delete_four') {
                const weeks = []; for(let i=0; i<4; i++) weeks.push(toLocalISOString(new Date(state.selectedMonday.getTime() + i*7*24*60*60*1000)));
                url += `batchDelete&weeks=${weeks.join(',')}`;
            } else if (type === 'single') url += `batchSchedule&type=single&startDate=${mondayStr}&templateIdx=${tplIdx}`;
            else url += `batchDelete&weeks=${mondayStr}`;
            
            const res = await (await fetch(url + `&userId=${state.userId}`)).json();
            if (res.status === 'success') showSuccess(res.message);
        }

        function startLoad() { document.getElementById('loading').classList.remove('hidden'); }
        function showSuccess(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('success-msg').textContent = msg; document.getElementById('modal-success').classList.replace('hidden', 'flex'); }
        async function closeSuccessModal() {
            document.getElementById('modal-success').classList.replace('flex', 'hidden');
            startLoad(); await refreshData(); renderCalendar();
            document.getElementById('loading').classList.add('hidden');
        }
        window.onload = init;
    </script>
</body>
</html>
