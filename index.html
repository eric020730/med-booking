<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫影部教學預約系統 V2</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .month-separator { grid-column: span 7 / span 7; }
        .admin-btn { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24">
    <div id="app" class="max-w-md mx-auto p-4">
        <!-- Loading -->
        <div id="loading" class="fixed inset-0 bg-white/90 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-slate-500 font-medium">資料同步中...</p>
            </div>
        </div>

        <div id="page-content" class="hidden">
            <!-- 標題與使用者資訊 -->
            <div class="bg-white rounded-3xl p-6 shadow-sm mb-4 flex justify-between items-center">
                <div>
                    <h1 id="main-title" class="text-xl font-black text-slate-800">教學預約系統</h1>
                    <p id="user-display" class="text-blue-600 text-xs font-bold mt-1"></p>
                </div>
                <!-- 管理員按鈕 (預設隱藏) -->
                <button id="admin-panel-btn" onclick="toggleAdminModal()" class="hidden admin-btn text-white p-3 rounded-2xl shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                </button>
            </div>

            <!-- 預約模式課程選擇 -->
            <div id="course-section" class="bg-white rounded-3xl p-6 shadow-sm mb-4 hidden">
                <h2 class="text-xs font-bold text-slate-400 uppercase mb-4">1. 選擇預約課程</h2>
                <div id="course-list" class="grid grid-cols-1 gap-2"></div>
            </div>

            <!-- 日曆容器 -->
            <div id="calendar-container" class="bg-white rounded-3xl p-6 shadow-sm mb-4">
                <h2 id="calendar-label" class="text-xs font-bold text-slate-400 uppercase mb-4">課表概覽</h2>
                <div id="calendar" class="grid grid-cols-7 gap-1 text-center text-xs"></div>
                
                <div id="day-detail" class="mt-6 pt-6 border-t border-slate-100 hidden">
                    <p id="selected-date-text" class="text-sm font-black text-slate-700 mb-4"></p>
                    <div id="time-slots" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理員專用 Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-6 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-[40px] p-8 w-full max-w-xs text-center shadow-2xl">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </div>
            <h3 class="text-lg font-bold mb-2">排課管理員工具</h3>
            <p class="text-slate-500 text-xs mb-6">系統將根據「課程模板」分頁，自動產生未來四週的課程時段。</p>
            
            <button onclick="executeLoadTemplate()" class="w-full admin-btn text-white py-4 rounded-2xl font-bold mb-3 shadow-lg">立即載入未來四週課程</button>
            <button onclick="toggleAdminModal()" class="w-full text-slate-400 py-2 text-sm font-medium">取消</button>
        </div>
    </div>

    <!-- 成功提示 (共用) -->
    <div id="success-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-6 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-[40px] p-10 w-full max-w-xs text-center shadow-2xl">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-xl font-black mb-2">操作成功</h3>
            <p id="success-msg" class="text-slate-500 mb-8 text-sm"></p>
            <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">確認</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzuMZYcMQbL3wllpVmHUmQWV6DnJa1jFA1DZ-siAsM1MJyULU0N7YNkeEASOfaMlDWR/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        let state = { userId: null, name: '', allEvents: [], isBookMode: false };

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            state.userId = profile.userId;

            const urlParams = new URLSearchParams(window.location.search);
            state.isBookMode = urlParams.get('action') === 'book';

            // 抓取資料
            const [userRes, eventRes, adminRes] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`),
                fetch(`${GAS_URL}?action=getAllEvents`),
                fetch(`${GAS_URL}?action=checkAdmin&userId=${state.userId}`)
            ]);

            const userData = await userRes.json();
            state.allEvents = await eventRes.json();
            const adminData = await adminRes.json();

            state.name = userData.name;
            document.getElementById('user-display').textContent = `${state.name} 醫師`;
            
            // 如果是管理員，顯示按鈕
            if (adminData.isAdmin) {
                document.getElementById('admin-panel-btn').classList.remove('hidden');
            }

            renderView(userData);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function renderView(userData) {
            if (state.isBookMode) {
                document.getElementById('course-section').classList.remove('hidden');
                document.getElementById('main-title').textContent = "預約課程";
                const list = document.getElementById('course-list');
                userData.courses.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = "p-4 border-2 border-slate-100 rounded-2xl text-left font-bold text-slate-600 transition-all active:scale-95";
                    btn.textContent = c;
                    btn.onclick = () => {
                        state.selectedCourse = c;
                        list.querySelectorAll('button').forEach(b => b.classList.replace('border-blue-500', 'border-slate-100'));
                        btn.classList.replace('border-slate-100', 'border-blue-500');
                        document.getElementById('calendar-container').classList.remove('opacity-30', 'pointer-events-none');
                    };
                    list.appendChild(btn);
                });
                document.getElementById('calendar-container').classList.add('opacity-30', 'pointer-events-none');
            }
            renderCalendar();
        }

        // --- 管理員操作 ---
        function toggleAdminModal() {
            const modal = document.getElementById('admin-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
        }

        async function executeLoadTemplate() {
            if (!confirm('確定要根據模板載入未來四週課程嗎？\n系統會自動略過已存在的時段。')) return;
            
            toggleAdminModal();
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const res = await fetch(`${GAS_URL}?action=loadTemplateCourses`);
                const result = await res.json();
                
                document.getElementById('loading').classList.add('hidden');
                if (result.status === 'success') {
                    document.getElementById('success-msg').innerHTML = `成功載入 ${result.count} 堂課程！<br>日曆與紀錄已更新。`;
                    document.getElementById('success-modal').classList.replace('hidden', 'flex');
                } else {
                    alert('載入失敗：' + result.message);
                }
            } catch (e) {
                alert('系統錯誤');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // --- 日曆渲染 (延續原版邏輯並優化) ---
        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            const weeks = ['一','二','三','四','五','六','日'];
            weeks.forEach(w => {
                const h = document.createElement('div');
                h.className = "text-slate-300 font-bold py-2";
                h.textContent = w;
                container.appendChild(h);
            });

            const today = new Date();
            const startOffset = (today.getDay() + 6) % 7;
            for (let i = 0; i < startOffset; i++) container.appendChild(document.createElement('div'));

            for (let i = 0; i < 42; i++) { // 顯示 6 週
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const dayEvents = state.allEvents.filter(e => e.start.startsWith(dateStr));
                
                const el = document.createElement('div');
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                el.className = `min-h-[70px] p-1 border border-slate-50 rounded-xl flex flex-col items-center cursor-pointer transition-all ${isWeekend ? 'bg-slate-50 text-slate-300' : 'bg-white hover:bg-blue-50'}`;
                
                el.innerHTML = `<span class="text-[10px] font-bold">${d.getDate()}</span>`;
                if (dayEvents.length > 0) {
                    const dotContainer = document.createElement('div');
                    dotContainer.className = "flex flex-wrap gap-0.5 mt-auto mb-1 px-1";
                    dayEvents.forEach(() => {
                        const dot = document.createElement('div');
                        dot.className = "w-1.5 h-1.5 bg-blue-500 rounded-full";
                        dotContainer.appendChild(dot);
                    });
                    el.appendChild(dotContainer);
                }
                
                el.onclick = () => showDetail(dateStr, dayEvents);
                container.appendChild(el);
            }
        }

        function showDetail(dateStr, events) {
            const detail = document.getElementById('day-detail');
            const tc = document.getElementById('time-slots');
            detail.classList.remove('hidden');
            document.getElementById('selected-date-text').textContent = `${dateStr} 時段細節`;
            tc.innerHTML = '';

            const hours = [9, 10, 11, 13, 14, 15, 16];
            hours.forEach(h => {
                const booked = events.find(e => new Date(e.start).getHours() === h);
                const div = document.createElement('div');
                div.className = "p-4 rounded-2xl border-2 flex justify-between items-center font-bold text-sm";
                
                if (state.isBookMode) {
                    if (booked) {
                        div.className += " bg-slate-50 border-slate-100 text-slate-300";
                        div.innerHTML = `<span>${h}:00</span> <span class="text-xs">已占用</span>`;
                    } else {
                        div.className += " border-blue-100 text-blue-600 active:bg-blue-600 active:text-white";
                        div.innerHTML = `<span>${h}:00</span> <span class="text-xs">可預約</span>`;
                        div.onclick = () => submitBooking(dateStr, h);
                    }
                } else {
                    div.className += booked ? " border-blue-200 bg-blue-50 text-blue-800" : " border-slate-100 text-slate-300";
                    div.innerHTML = `<span>${h}:00</span> <span class="text-xs font-normal">${booked ? booked.title : '無課程'}</span>`;
                }
                tc.appendChild(div);
            });
            detail.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function submitBooking(date, hour) {
            const time = `${date}T${String(hour).padStart(2,'0')}:00:00`;
            if (!confirm(`確認預約 ${time.replace('T',' ')}？`)) return;
            document.getElementById('loading').classList.remove('hidden');
            const res = await fetch(`${GAS_URL}?action=submitBooking&name=${state.name}&course=${state.selectedCourse}&startTime=${time}&userId=${state.userId}`);
            const result = await res.json();
            if (result.status === 'success') {
                document.getElementById('success-msg').textContent = '預約成功！已同步至日曆。';
                document.getElementById('success-modal').classList.replace('hidden', 'flex');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
