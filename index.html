<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>醫影部排課助理</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { @apply overflow-hidden; } /* 防止整頁滾動 */
        
        /* 核心佈局：頁首(15%) + 日曆(85%) */
        .app-container { height: 100vh; @apply flex flex-col; }
        .header-section { height: 12vh; @apply flex flex-col justify-center items-center shrink-0; }
        .calendar-section { height: 88vh; @apply px-1 pb-2 flex-grow; }

        /* 月曆格子：使用高度百分比確保 6 週塞進一頁 */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: 25px repeat(5, 1fr); 
            grid-template-rows: 25px repeat(6, 1fr); 
            height: 100%;
            gap: 2px;
        }

        .day-cell { 
            @apply border border-slate-100 rounded-lg flex flex-col items-center relative bg-white transition-all overflow-hidden; 
            padding: 2px;
        }

        /* 今日標示：尺寸縮小，字體加粗 */
        .is-today-dot { @apply bg-blue-600 text-white rounded-full flex items-center justify-center font-black shadow-sm text-[10px]; width: 18px; height: 18px; }
        .is-today-cell { @apply bg-blue-50/50 border-blue-300 !important; }

        /* 側欄週次 */
        .week-label { @apply flex items-center justify-center text-[8px] font-black text-slate-300; }

        /* 課程標籤：極致縮減，僅顯示時間與姓 */
        .course-tag { 
            @apply text-[7px] leading-none rounded-sm mb-0.5 w-full truncate text-center font-bold; 
            padding: 1px 0;
        }
        .my-event-bg { background-color: #f3e8ff !important; color: #7e22ce !important; }
        .event-default-bg { background-color: #eff6ff !important; color: #2563eb !important; }
        
        /* 過去淡化 */
        .past-event { opacity: 0.3 !important; filter: grayscale(1); }

        /* 詳情面板：覆蓋式或滾動式 */
        #day-detail { @apply fixed bottom-0 left-0 right-0 bg-white shadow-2xl rounded-t-[2rem] z-50 transform translate-y-full transition-transform duration-300; max-height: 60vh; overflow-y: auto; }
        #day-detail.active { @apply translate-y-0; }

        .btn-action { @apply px-4 py-2 rounded-xl font-black text-xs transition-all active:scale-95; }
        .btn-primary { @apply btn-action bg-blue-600 text-white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
    <div id="app" class="app-container">
        <!-- 載入動畫 -->
        <div id="loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[100]">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-blue-600 mb-2"></div>
            <p class="text-xs font-black">同步中...</p>
        </div>

        <div id="page-content" class="hidden h-full flex flex-col">
            <header class="header-section">
                <h1 class="text-lg font-black tracking-tight">醫影部排課助手</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="user-info" class="text-[10px] bg-blue-100 text-blue-700 px-3 py-0.5 rounded-full font-bold">讀取中...</span>
                    <span id="mode-badge" class="text-[10px] bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full font-black">查詢</span>
                </div>
            </header>

            <main class="calendar-section">
                <div id="calendar" class="calendar-grid"></div>
            </main>
        </div>

        <!-- 點選後的詳情抽屜 -->
        <div id="day-detail" class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="selected-date-text" class="text-lg font-black"></h3>
                <button onclick="closeDetail()" class="text-slate-400 font-bold">關閉</button>
            </div>
            <div id="time-slots" class="space-y-2"></div>
        </div>
    </div>

    <!-- 成功提示 -->
    <div id="modal-success" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[101]">
        <div class="bg-white rounded-3xl p-8 w-full max-w-xs text-center">
            <p id="success-msg" class="font-black mb-6"></p>
            <button onclick="closeSuccess()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">確定</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyu0c5Rmhrac2VzL8QV6Rq4IocF4FMI-9t0bDiHLMRLwWArKwTicMK40d4dXYRcfG_dbg/exec';
        const LIFF_ID = '2008853844-2zr8uzLz';
        let state = { userId: null, name: '', action: 'view', allEvents: [], userCourses: [], selectedDate: null };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.userId = profile.userId;
                state.action = new URLSearchParams(window.location.search).get('action') || 'view';
                await refreshData();
                showMain();
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            const [u, e] = await Promise.all([
                fetch(`${GAS_URL}?action=getUserData&userId=${state.userId}`).then(r => r.json()),
                fetch(`${GAS_URL}?action=getAllEvents`).then(r => r.json())
            ]);
            state.allEvents = e;
            state.name = (u.name || '訪客').replace(/醫師/g, '').trim();
            state.userCourses = (u.courses || []).filter(c => c);
            document.getElementById('user-info').textContent = u.name || '訪客';
        }

        function showMain() {
            renderCalendar();
            document.getElementById('mode-badge').textContent = { 'admin':'管理', 'book':'預約', 'modify':'修改' }[state.action] || '查詢';
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('page-content').classList.remove('hidden');
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            
            // Header: 一~五
            container.appendChild(document.createElement('div'));
            ['一','二','三','四','五'].forEach(w => {
                const h = document.createElement('div');
                h.className = "flex items-center justify-center text-[10px] font-black text-slate-300";
                h.textContent = w;
                container.appendChild(h);
            });

            const today = new Date(); today.setHours(0,0,0,0);
            const todayStr = today.toISOString().split('T')[0];
            const startMon = new Date(today.getTime() + (today.getDay() === 0 ? -6 : 1 - today.getDay()) * 86400000);

            for (let week = 0; week < 6; week++) {
                const weekLabel = document.createElement('div');
                weekLabel.className = "week-label";
                weekLabel.textContent = `W${(week % 4) + 1}`;
                container.appendChild(weekLabel);

                for (let day = 0; day < 5; day++) {
                    const d = new Date(startMon.getTime() + (week * 7 + day) * 86400000);
                    const ds = d.toISOString().split('T')[0];
                    const events = state.allEvents.filter(ev => ev.start.startsWith(ds));
                    const isToday = ds === todayStr;

                    const el = document.createElement('div');
                    el.className = `day-cell ${isToday ? 'is-today-cell' : ''}`;
                    el.innerHTML = `<div class="${isToday ? 'is-today-dot' : 'text-[10px] font-black'}">${d.getDate()}</div>`;
                    
                    // 僅顯示前兩門課，避免撐開
                    events.slice(0, 3).forEach(ev => {
                        const h = new Date(ev.start).getHours();
                        const doc = ev.title.split('醫師')[0].slice(-1); // 僅取最後一個字
                        const isMine = ev.title.includes(state.name);
                        el.innerHTML += `<div class="course-tag ${isMine ? 'my-event-bg' : 'event-default-bg'} ${d < today && !isToday ? 'past-event' : ''}">${h}${doc}</div>`;
                    });

                    el.onclick = () => showDetail(d, events);
                    container.appendChild(el);
                }
            }
        }

        function showDetail(date, events) {
            state.selectedDate = date;
            const ds = date.toISOString().split('T')[0];
            document.getElementById('selected-date-text').textContent = ds;
            const tc = document.getElementById('time-slots');
            tc.innerHTML = '';
            
            [9, 10, 11, 13, 14, 15, 16].forEach(h => {
                const booked = events.find(ev => new Date(ev.start).getHours() === h);
                const row = document.createElement('div');
                row.className = "p-4 border rounded-2xl flex justify-between items-center";
                
                let html = `<span class="text-sm font-bold text-slate-400">${h}:00 空閒</span>`;
                if(booked) {
                    const isMine = booked.title.includes(state.name);
                    html = `<span class="text-sm font-black ${isMine ? 'text-purple-600':'text-slate-800'}">${h}:00 ${booked.title}</span>`;
                } else if(state.action === 'book') {
                    html += `<button onclick="doBook(${h})" class="btn-primary">預約</button>`;
                }
                row.innerHTML = html;
                tc.appendChild(row);
            });
            document.getElementById('day-detail').classList.add('active');
        }

        function closeDetail() { document.getElementById('day-detail').classList.remove('active'); }

        async function doBook(hour) {
            if(!state.userCourses[0]) return alert('無可用課程');
            startLoad();
            const ds = state.selectedDate.toISOString().split('T')[0];
            const res = await fetch(`${GAS_URL}?action=submitBooking&name=${state.name}&course=${state.userCourses[0]}&startTime=${ds}T${hour}:00:00&userId=${state.userId}`).then(r => r.json());
            if(res.status === 'success') { closeDetail(); showSuccess('預約完成'); }
        }

        function startLoad() { document.getElementById('loading').classList.remove('hidden'); }
        function showSuccess(m) { document.getElementById('success-msg').textContent = m; document.getElementById('modal-success').classList.replace('hidden', 'flex'); }
        function closeSuccess() { location.reload(); }

        window.onload = init;
    </script>
</body>
</html>
